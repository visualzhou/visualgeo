<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <title>Visualize MongoDB Geo Query Explain</title>
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
      #map-canvas { 
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
      }
      #controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        max-width: 600px;
        resize: both;
        overflow: auto;
      }
      #explain_text {
        width: 100%;
        min-width: 300px;
        min-height: 80px;
        margin-bottom: 10px;
        resize: both;
        box-sizing: border-box;
      }
      #drop-container {
        display: none;
        height: 100%;
        width: 100%;
        position: absolute;
        z-index: 1;
        top: 0px;
        left: 0px;
        padding: 20px;
        background-color: rgba(100, 100, 100, 0.5);
      }
      #drop-silhouette {
        color: white;
        border: white dashed 8px;
        height: calc(100% - 56px);
        width: calc(100% - 56px);
        background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAAXNSR0IArs4c6QAAAAZiS0dEAGQAZABkkPCsTwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB90LHAIvICWdsKwAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAACdklEQVR42u3csU7icBzA8Xp3GBMSeRITH8JHMY7cRMvmVmXoE9TAcJubhjD4ApoiopgqDMWAKAgIcSAiCfxuwhwROVJbkPD9rP23ob8vpZCQKgoAAAAAAAAAAPDYyiK/eNM05bNtr6+vSjgcXiHxDMkE1WpVFvGcfpCVICAIQUAQgoAgBAFBCAKCgCAEAUEIAoIQBAQhCAgCghAEBCEICEIQEIQgIAgIQhAQhCAgCEFAEIKAICAIQUAQgoAgBAFBCDIzhmFINBo9/K6D0XVddnd3ZaneDY7jSCqVcn3SfjyeKRKJbJ2dnYllWbKUl2i5XJaXlxdJJBIy7yDHx8fy9vYm6XR6OWMM3d/fi4hIqVSSWCwmsw5ycHAgrVZLRETOz8+XO8ZQpVJ5H2Y6nRZN0/b9DqLruhSLxfd9MpkMMT6L0uv1JJlMih9BhveJwWDwvv7i4oIY4zw8PIwMtt1uSzweF6+CHB0dSbfbHVmbzWaJMcnj4+OHAd/d3cne3p64DWKapjw/P39Yd3l5SYxpVKvVsYO2LEtUVd2ZNoiu6+I4ztg1V1dXxPAiSq/Xk5OTk0k9pNVqyenp6ch94l+5XI4YbtRqNfHa9fX1t43xcwGa/Nnc3PwdDAY9OZht28rGxgZPvP6KSCSy9fT09OUrw7ZtPqa8jFKv113HuLm5IYbXVFXdcRPl9vaWGH5GaTQaU8fI5/PE8JumafvNZvO/MQqFAjFmJRqNHk6Ksqgx5vr1zzAM2d7edr3/6uqqsra2NnZbp9NR+v2+62OHQqG5zObXPIMEAgFlfX3dl2N79btl1viTA0FAEIKAIAQBAAAAAAAAsMz+Ai1bUgo6ebm8AAAAAElFTkSuQmCC');
        background-repeat: no-repeat;
        background-position: center;
      }
    </style>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="text/javascript">
      // Set up Module configuration BEFORE loading s2.js
      var Module = {
        onRuntimeInitialized: function() {
          console.log("S2 Module initialized successfully");
          window.s2ModuleReady = true;
        }
      };
      window.s2ModuleReady = false;
    </script>
    <script type="text/javascript" src="/static/js/s2.js"></script>
    <script type="text/javascript">
/* Map functions */

var map;
var nearExplain;
var geoJsonLayers = []; // Store all GeoJSON layers for clearing

function initMap() {
  // set up the map with Leaflet
  map = L.map('map-canvas').setView([0, 0], 2);
  
  // Add OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors',
    maxZoom: 19
  }).addTo(map);
}

function parseRelaxedJSON(jsonString) {
  // Strip out MongoDB-specific types
  let cleaned = jsonString;
  
  // Remove $clusterTime object (which has nested structure)
  // This regex handles one level of nesting for the signature object
  cleaned = cleaned.replace(/['"]?\$clusterTime['"]?\s*:\s*\{(?:[^{}]|\{[^{}]*\})*\}\s*,?/g, '');
  
  // Remove Binary.createFromBase64(...) and replace with a string
  // cleaned = cleaned.replace(/Binary\.createFromBase64\(\s*'([^']*)',\s*\d+\s*\)/g, '"$1"');
  // cleaned = cleaned.replace(/Binary\.createFromBase64\(\s*"([^"]*)",\s*\d+\s*\)/g, '"$1"');
  
  // Remove Timestamp(...) and replace with the inner object
  cleaned = cleaned.replace(/(Timestamp\([^)]*\))/g, '"{$1}"');
  
  // Remove Long(...) and replace with the inner value
  cleaned = cleaned.replace(/Long\(\s*'([^']*)'\s*\)/g, '"$1"');
  
  // Add quotes to unquoted keys - match key: value patterns
  // This regex looks for word characters followed by colon, ensuring it's not already quoted
  cleaned = cleaned.replace(/([{,]\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)\s*:/g, '$1"$2":');

  // Replace single quotes with double quotes.
  cleaned = cleaned.replace(/'/g, '"');
  
  return JSON.parse(cleaned);
}

function loadGeoJsonString(geoString) {
  var geojson = parseRelaxedJSON(geoString);
  return loadGeoJson(geojson);
}

function loadGeoJson(geometry, properties) {
  var feature = {
    type: "Feature",
    id: 0,
    geometry: geometry,
    properties: properties || {},
  }
  
  // Determine style based on properties
  var style = {
    fillColor: properties && properties.cellUnion ? 'grey' : (properties && properties.covering ? 'blue' : 'red'),
    fillOpacity: properties && properties.cellUnion ? 0.1 : (properties && properties.covering ? 0.3 : 0.2),
    color: properties && properties.cellUnion ? 'grey' : (properties && properties.covering ? 'blue' : 'red'),
    weight: properties && properties.covering ? 2 : 1
  };
  
  var layer = L.geoJSON(feature, {
    style: style
  }).addTo(map);
  
  geoJsonLayers.push(layer);
  zoom();
  return layer;
}

/**
 * Update a map's viewport to fit all geometry layers
 */
function zoom() {
  if (geoJsonLayers.length === 0) return;
  
  var group = L.featureGroup(geoJsonLayers);
  if (nearExplain && nearExplain.drawing) {
    nearExplain.drawing.forEach(function(circle) {
      group.addLayer(circle);
    });
  }
  
  try {
    var bounds = group.getBounds();
    
    // Check if bounds are valid (not infinite or spanning the whole world)
    var sw = bounds.getSouthWest();
    var ne = bounds.getNorthEast();
    var latSpan = Math.abs(ne.lat - sw.lat);
    var lngSpan = Math.abs(ne.lng - sw.lng);
    
    // If bounds are suspiciously large (e.g., spanning more than 90 degrees),
    // it might be due to large S2 cells in the covering. Use a more conservative zoom.
    if (latSpan > 90 || lngSpan > 90) {
      console.warn("Bounds are very large, using conservative zoom level");
      // Calculate center
      var centerLat = (ne.lat + sw.lat) / 2;
      var centerLng = (ne.lng + sw.lng) / 2;
      map.setView([centerLat, centerLng], 4);
    } else {
      // Add padding to prevent over-zooming on small geometries
      map.fitBounds(bounds, {
        padding: [50, 50],
        maxZoom: 18  // Prevent excessive zoom for very small areas
      });
    }
  } catch (e) {
    console.error("Error fitting bounds:", e);
    // Fallback to a reasonable default view if bounds fail
    map.setView([0, 0], 2);
  }
}


/* DOM (drag/drop) functions */

function initEvents() {
  // set up the drag & drop events
  var mapContainer = document.getElementById('map-canvas');
  var dropContainer = document.getElementById('drop-container');

  // first on common events
  [mapContainer, dropContainer].forEach(function(container) {
    container.addEventListener('drop', handleDrop, false);
    container.addEventListener('dragover', showPanel, false);
  });

  // then map-specific events
  mapContainer.addEventListener('dragstart', showPanel, false);
  mapContainer.addEventListener('dragenter', showPanel, false);

  // then the overlay specific events (since it only appears once drag starts)
  dropContainer.addEventListener('dragend', hidePanel, false);
  dropContainer.addEventListener('dragleave', hidePanel, false);
}

function showPanel(e) {
  e.stopPropagation();
  e.preventDefault();
  document.getElementById('drop-container').style.display = 'block';
  return false;
}

function hidePanel(e) {
  document.getElementById('drop-container').style.display = 'none';
}

function handleDrop(e) {
  e.preventDefault();
  e.stopPropagation();
  hidePanel(e);

  var files = e.dataTransfer.files;
  if (files.length) {
    // process file(s) being dropped
    // grab the file data from each file
    for (var i = 0, file; file = files[i]; i++) {
      var reader = new FileReader();
      reader.onload = function(e) {
        loadGeoJsonString(e.target.result);
      };
      reader.onerror = function(e) {
        console.error('reading failed');
      };
      reader.readAsText(file);
    }
  } else {
    // process non-file (e.g. text or html) content being dropped
    // grab the plain text version of the data
    var plainText = e.dataTransfer.getData('text/plain');
    if (plainText) {
      loadGeoJsonString(plainText);
    }
  }

  // prevent drag event from bubbling further
  return false;
}

// { type: "Annulus", center: [lng, lat], min: 0, max: 10 /* meters */ }

function ShapeAndCovering(id) {
  // query GeoJSON or Annnulas
  this.shape = null;
  // Array of GeoJSON, each polygon represents a cell
  this.covering = [];
  this.id = id;
  // Features to diplay
}

function get2dSphereField(stage) {
  if (stage.stage != "IXSCAN") return null;
  keyPattern = stage.keyPattern;
  if (keyPattern == null) return null;
  var res = null;
  Object.getOwnPropertyNames(keyPattern).forEach(function(field) {
    if (keyPattern[field] == "2dsphere") {
      res = field;
    }})

  return res;
}

function findField(node, expectedField) {
  res = null;
  if (node instanceof Array) {
    for (let entry of node) {
      res = findField(entry, expectedField);
      if (res != null) {
        return res;
      }
    }
  }
  if (node === null || typeof node !== 'object') {
    return null;
  }

  nodeKeys = Object.getOwnPropertyNames(node);
  for (i = 0; i < nodeKeys.length; i++) {
    field = nodeKeys[i];
    if (field == expectedField) {
      return node[field];
    } else {
      res = findField(node[field], expectedField);
      if (res != null) {
        return res;
      }
    }
  }
  return res;
}


// bounds is the array of string
// [
//   "[\"0f1332332\", \"0f1332332\"]",
//   "[\"0f13323323\", \"0f13323323\"]",
// ]
function translateIndexBoundsToCellIds(bounds) {
  // Only show intervals, no points
  var boundRe = /\W(.*),\s*(.*)\W$/;
  var cellBounds = [];
  bounds.forEach(function(bound) {
    var m = boundRe.exec(bound);
    // TODO: Given that finest query level is 23, if start == end, that must be a point query.
    if (m[1] !== m[2]) cellBounds.push({start: m[1], end: m[2]});
  });
  var cellIds = [];
  // cellBounds ["0f1332332", "0f13323323"]
  cellBounds.forEach(function(cell) {
    if (cell.start.startsWith('"')) {
      // '"0f1332332"'
      cellIds.push(cell.start.slice(1, -1));
    } else {
      // '563805707163664385'
      var cellId = Module.getCellIdFromMinMax(cell.start, cell.end);
      cellIds.push(cellId);
    }
  });
  return cellIds;
}

function translateCellIdToGeoJSON(cellId) {
    var points = Module.getPolygonFromCellId(cellId);
    var loop = [];
    for (var i = 0; i < points.size(); i++) {
      // The last LngLat is the same with the first one.
      var ll = points.get(i % points.size());
      loop.push([ll.lng, ll.lat]);
    }
    return { type: "Polygon", coordinates: [loop]};
}

function clearMap() {
  // Remove all GeoJSON layers
  geoJsonLayers.forEach(function(layer) {
    map.removeLayer(layer);
  });
  geoJsonLayers = [];
  
  // Remove circle drawings
  if (nearExplain && nearExplain.drawing) {
    nearExplain.drawing.forEach(function(circle) {
      map.removeLayer(circle);
    });
    nearExplain.drawing = [];
  }
}

function showGeoQueryExplain(shapeAndCovering) {
  clearMap();
  loadGeoJson(shapeAndCovering.shape);
  shapeAndCovering.covering.forEach(function(cellId) {
    var polygon = translateCellIdToGeoJSON(cellId);
    loadGeoJson(polygon, {covering: true});
  });
}

function parseGeoQueryExplain(explain) {
  var execStages = explain.executionStats.executionStages;
  var stage = findStage(execStages, function(st){return get2dSphereField(st) != null;});

  if (stage == null) {
    console.log("No geo stage found in explain");
    return;
  }

  var geoField = get2dSphereField(stage);
  
  // Convert stage.indexBounds
  var covering = translateIndexBoundsToCellIds(stage.indexBounds[geoField]);

  var shapeAndCovering = new ShapeAndCovering(0);
  shapeAndCovering.covering = covering;
  shapeAndCovering.shape = findField(explain.queryPlanner.parsedQuery, "$geometry");
  showGeoQueryExplain(shapeAndCovering);
}


// ----------- Geo Near -----------
// { type: "Annulus", center: [lng, lat], min: 0, max: 10 /* meters */ }
function Annulus(center, min, max) {
  this.type = "Annulus";
  this.center = center;
  this.min = min;
  this.max = max;

}

function NearExplain() {
  this.stages = [];
  this.rootStage = null;
  this.curStage = 0;
  this.drawing = [];
}

function drawCircle(center, radius) {
  // Leaflet uses [lat, lng] order, center is [lng, lat]
  var circle = L.circle([center[1], center[0]], {
    color: '#FF0000',
    opacity: 0.8,
    weight: 4,
    fillColor: '#FF0000',
    fillOpacity: 0,
    radius: radius  // radius in meters
  }).addTo(map);
  
  nearExplain.drawing.push(circle);
  geoJsonLayers.push(circle);  // Also add to geoJsonLayers for bounds calculation
}

function showGeoNearExplain() {
  clearMap();
  
  nearExplain.stages[nearExplain.curStage].coverings.forEach(function(cellId) {
    var polygon = translateCellIdToGeoJSON(cellId);
    loadGeoJson(polygon, {covering: true});
  });

  // Draw cell union
  cells = new Module.VectorString();
  for (var i = 0; i < nearExplain.curStage; i++) {
    var stage = nearExplain.stages[i];
    stage.coverings.forEach(function(cellId) {
      cells.push_back(cellId);
    });
  }
  cells = Module.getCellUnion(cells);
  for (var i = 0; i < cells.size(); i++) {
    var polygon = translateCellIdToGeoJSON(cells.get(i));
    loadGeoJson(polygon, {cellUnion: true});
  }
  
  // Styles are now handled in loadGeoJson based on properties

  var annulus = nearExplain.stages[nearExplain.curStage].shape;
  drawCircle(annulus.center, annulus.min);
  drawCircle(annulus.center, annulus.max);
  
  zoom();
}

/*
Recursively searches stages, returning the shallowest which satisfies
the condition function
@param {Object|Array} root_stage
@param {Function} condition
*/
function findStage(root_stage, condition){
  var q = [];
  if(typeof(root_stage) == "array"){
    q = q.concat(root_stage);
  } else {
    q.push(root_stage);
  }
  while(q.length > 0){
    var stage = q.shift();
    if(condition.call(window, stage)){
      return stage;
    } else {
      if(stage.hasOwnProperty("inputStage")){
        q.push(stage.inputStage);
      } else if(stage.hasOwnProperty("inputStages")){
        q = q.concat(stage.inputStages);
      }
    }
  }
  return null;
}

function parseGeoNearExplain(explain) {
  var execStages = explain.executionStats.executionStages;
  var rootStage = findStage(execStages, function(st){return st.stage == "GEO_NEAR_2DSPHERE";});
  if (!rootStage) {
    return null;
  }

  nearExplain = new NearExplain();
  nearExplain.rootStage = rootStage;

  // Get center
  var nearQueryPred = findField(explain.queryPlanner.parsedQuery, "$near");
  if (nearQueryPred == null) {
    nearQueryPred = findField(explain.queryPlanner.parsedQuery, "$nearSphere");
  }
  if (nearQueryPred == null) {
    console.log("Could not find geo predicate within: ", explain.queryPlanner.parsedQuery)
  }
  var center;
  if (nearQueryPred["$geometry"]) {
    center = nearQueryPred["$geometry"].coordinates;
  } else {
    center = nearQueryPred;
  }

  // Search annulus
  rootStage.searchIntervals.forEach(function(interval, idx) {
    var annulus = new Annulus(center, interval.minDistance, interval.maxDistance);
    var shapeAndCovering = new ShapeAndCovering(idx);
    shapeAndCovering.shape = annulus;
    nearExplain.stages.push(shapeAndCovering);
  });

  var curStage = 0;

  // Get initial indexBounds to find the fieldName used in the query
  var indexBoundsStage = findStage(rootStage, function(st){return st.hasOwnProperty("indexBounds"); });
  
  if (!indexBoundsStage) {
    console.error("No indexBounds found in rootStage");
    showGeoNearExplain();
    return nearExplain;
  }
  
  var indexBounds = indexBoundsStage["indexBounds"];
  
  // Find the geo field name using get2dSphereField, or by finding bounds that look like S2 cell IDs
  var fieldName = get2dSphereField(indexBoundsStage);
  if (!fieldName) {
    // Fallback: find the field with S2-style bounds (strings that look like cell IDs, not booleans)
    var fieldNames = Object.getOwnPropertyNames(indexBounds);
    for (var i = 0; i < fieldNames.length; i++) {
      var bounds = indexBounds[fieldNames[i]];
      if (bounds && bounds.length > 0 && typeof bounds[0] === 'string' && bounds[0].length > 10 && bounds[0].indexOf('[') !== 0) {
        fieldName = fieldNames[i];
        break;
      }
    }
  }
  
  if (!fieldName) {
    console.error("Could not find geo field in indexBounds");
    showGeoNearExplain();
    return nearExplain;
  }

  // Translate S2 GeoHash to GeoJSON polygons
  if(rootStage.hasOwnProperty("inputStages")){
      for (var i = 0; i < rootStage.inputStages.length; i++) {
        var stageWithBounds = findStage(rootStage.inputStages[i], function(st){return st.hasOwnProperty("indexBounds"); });
        if (stageWithBounds) {
          indexBounds = stageWithBounds["indexBounds"];
          var bounds = indexBounds[fieldName];
          nearExplain.stages[i].coverings = translateIndexBoundsToCellIds(bounds);
        }
      }
  } else if(rootStage.hasOwnProperty("inputStage")){
      nearExplain.stages[0].coverings = translateIndexBoundsToCellIds(indexBounds[fieldName]);
  }

  showGeoNearExplain();

  return nearExplain;
}

function parseExplain(explain) {
  clearMap();
  nearExplain = null;
  var isNear = parseGeoNearExplain(explain);
  if (isNear) return;
  parseGeoQueryExplain(explain);
}

// ----------- Geo Near -----------

window.addEventListener('load', function() {
  initMap();
  initEvents();
});

$(document).ready(function() {
   $('#show_button').click(function() {
      try {
        // Check if S2 Module is ready
        if (typeof Module === 'undefined' || !window.s2ModuleReady) {
          alert("S2 Module is still loading. Please wait a moment and try again.");
          console.log("Module defined:", typeof Module !== 'undefined', "Module ready:", window.s2ModuleReady);
          return;
        }
        
        var jsonText = $('#explain_text').val();
        console.log("Parsing JSON of length:", jsonText.length);
        var explainData = parseRelaxedJSON(jsonText);
        console.log("JSON parsed successfully");
        parseExplain(explainData);
      } catch (e) {
        console.error("Error details:", e);
        alert("Error: " + e.name + ": " + e.message + "\n\nCheck the console for more details.");
      }
   });

   $('#prev_button').click(function() {
      if (nearExplain == null) {
        console.log("nearExplain is null");
        return;
      }

      if (nearExplain.curStage > 0) nearExplain.curStage--;
      showGeoNearExplain();
   });


   $('#next_button').click(function() {
      if (nearExplain == null) {
        console.log("nearExplain is null");
        return;
      }

      if (nearExplain.curStage < nearExplain.stages.length - 1) nearExplain.curStage++;
      showGeoNearExplain();
   });
});

    </script>
  </head>
  <body>
    <div id="controls">
      <textarea class="form-control" id="explain_text" cols="30" rows="3">
       {"queryPlanner":{"plannerVersion":1,"namespace":"test.geogeo","indexFilterSet":false,"parsedQuery":{"loc":{"$nearSphere":{"$geometry":{"type":"Point","coordinates":[-73.98784,40.75747]},"$maxDistance":1000000}}},"winningPlan":{"stage":"GEO_NEAR_2DSPHERE","keyPattern":{"loc":"2dsphere"},"indexName":"loc_2dsphere","inputStages":[{"stage":"FETCH","inputStage":{"stage":"IXSCAN","filter":{"TwoDSphereKeyInRegionExpression":true},"keyPattern":{"loc":"2dsphere"},"indexName":"loc_2dsphere","isMultiKey":false,"indexVersion":1,"direction":"forward","indexBounds":{"loc":["[\"4f1032010\", \"4f1032010\"]","[\"4f10320102\", \"4f10320102\"]","[\"4f103201020\", \"4f103201020\"]","[\"4f1032010202\", \"4f1032010203\")","[\"4f103201021\", \"4f103201021\"]","[\"4f1032010213\", \"4f1032010213\"]","[\"4f10320102133\", \"4f10320102134\")","[\"4f103201022\", \"4f103201023\")","[\"4f103201023\", \"4f103201024\")","[\"4f10320103\", \"4f10320103\"]","[\"4f103201030\", \"4f103201030\"]","[\"4f1032010300\", \"4f1032010301\")","[\"4f1032011\", \"4f1032011\"]","[\"4f10320110\", \"4f10320110\"]","[\"4f103201101\", \"4f103201101\"]","[\"4f1032011011\", \"4f1032011011\"]","[\"4f10320110111\", \"4f10320110112\")","[\"4f10320113\", \"4f10320113\"]","[\"4f103201132\", \"4f103201133\")","[\"4f103201133\", \"4f103201134\")"]}}},{"stage":"FETCH","inputStage":{"stage":"IXSCAN","filter":{"TwoDSphereKeyInRegionExpression":true},"keyPattern":{"loc":"2dsphere"},"indexName":"loc_2dsphere","isMultiKey":false,"indexVersion":1,"direction":"forward","indexBounds":{"loc":["[\"4f1032010\", \"4f1032010\"]","[\"4f10320100\", \"4f10320100\"]","[\"4f103201002\", \"4f103201003\")","[\"4f10320101\", \"4f10320102\")","[\"4f10320102\", \"4f10320103\")","[\"4f10320103\", \"4f10320104\")","[\"4f1032011\", \"4f1032012\")","[\"4f1032012\", \"4f1032012\"]","[\"4f10320120\", \"4f10320121\")","[\"4f1032013\", \"4f1032013\"]","[\"4f10320131\", \"4f10320132\")","[\"4f10320132\", \"4f10320132\"]","[\"4f103201321\", \"4f103201322\")"]}}},{"stage":"FETCH","inputStage":{"stage":"IXSCAN","filter":{"TwoDSphereKeyInRegionExpression":true},"keyPattern":{"loc":"2dsphere"},"indexName":"loc_2dsphere","isMultiKey":false,"indexVersion":1,"direction":"forward","indexBounds":{"loc":["[\"4f1032002\", \"4f1032003\")","[\"4f1032003\", \"4f1032004\")","[\"4f1032010\", \"4f1032011\")","[\"4f1032011\", \"4f1032012\")","[\"4f1032012\", \"4f1032013\")","[\"4f1032013\", \"4f1032014\")","[\"4f1032020\", \"4f1032021\")","[\"4f1032021\", \"4f1032021\"]","[\"4f10320210\", \"4f10320211\")","[\"4f1032321\", \"4f1032321\"]","[\"4f10323212\", \"4f10323213\")","[\"4f1032322\", \"4f1032323\")","[\"4f1033033\", \"4f1033033\"]","[\"4f10330333\", \"4f10330334\")","[\"4f1033100\", \"4f1033101\")","[\"4f1033103\", \"4f1033104\")","[\"4f1033110\", \"4f1033110\"]","[\"4f10331100\", \"4f10331100\"]","[\"4f103311000\", \"4f103311001\")"]}}},{"stage":"FETCH","inputStage":{"stage":"IXSCAN","filter":{"TwoDSphereKeyInRegionExpression":true},"keyPattern":{"loc":"2dsphere"},"indexName":"loc_2dsphere","isMultiKey":false,"indexVersion":1,"direction":"forward","indexBounds":{"loc":["[\"4f1032000\", \"4f1032001\")","[\"4f1032001\", \"4f1032002\")","[\"4f1032002\", \"4f1032003\")","[\"4f1032003\", \"4f1032004\")","[\"4f1032012\", \"4f1032013\")","[\"4f1032013\", \"4f1032013\"]","[\"4f10320133\", \"4f10320133\"]","[\"4f103201333\", \"4f103201333\"]","[\"4f1032013333\", \"4f1032013333\"]","[\"4f10320133333\", \"4f10320133334\")","[\"4f1032020\", \"4f1032021\")","[\"4f1032021\", \"4f1032022\")","[\"4f1032022\", \"4f1032023\")","[\"4f1032023\", \"4f1032024\")","[\"4f1032030\", \"4f1032031\")","[\"4f1032031\", \"4f1032032\")","[\"4f1032032\", \"4f1032033\")","[\"4f1032033\", \"4f1032033\"]","[\"4f10320331\", \"4f10320332\")","[\"4f1032311\", \"4f1032312\")","[\"4f1032312\", \"4f1032313\")","[\"4f1032313\", \"4f1032314\")","[\"4f1032320\", \"4f1032321\")","[\"4f1032321\", \"4f1032322\")","[\"4f1032322\", \"4f1032323\")","[\"4f1032323\", \"4f1032324\")","[\"4f1033020\", \"4f1033020\"]","[\"4f10330201\", \"4f10330201\"]","[\"4f103302011\", \"4f103302011\"]","[\"4f1033020111\", \"4f1033020112\")","[\"4f1033023\", \"4f1033024\")","[\"4f1033030\", \"4f1033031\")","[\"4f1033031\", \"4f1033032\")","[\"4f1033032\", \"4f1033033\")","[\"4f1033033\", \"4f1033034\")","[\"4f1033100\", \"4f1033101\")","[\"4f1033101\", \"4f1033102\")","[\"4f1033102\", \"4f1033103\")","[\"4f1033103\", \"4f1033104\")","[\"4f1033110\", \"4f1033111\")","[\"4f1033111\", \"4f1033112\")","[\"4f1033112\", \"4f1033112\"]","[\"4f10331120\", \"4f10331120\"]","[\"4f103311200\", \"4f103311201\")","[\"4f1033113\", \"4f1033114\")","[\"4f1033120\", \"4f1033120\"]","[\"4f10331200\", \"4f10331200\"]","[\"4f103312000\", \"4f103312000\"]","[\"4f1033120000\", \"4f1033120001\")","[\"4f1033131\", \"4f1033132\")","[\"4f1033132\", \"4f1033133\")"]}}},{"stage":"FETCH","inputStage":{"stage":"IXSCAN","filter":{"TwoDSphereKeyInRegionExpression":true},"keyPattern":{"loc":"2dsphere"},"indexName":"loc_2dsphere","isMultiKey":false,"indexVersion":1,"direction":"forward","indexBounds":{"loc":["[\"2f1211122\", \"2f1211122\"]","[\"2f12111222\", \"2f12111223\")","[\"2f12112\", \"2f12113\")","[\"2f12121\", \"2f12122\")","[\"4f1030122\", \"4f1030122\"]","[\"4f10301222\", \"4f10301223\")","[\"4f10302\", \"4f10303\")","[\"4f10312\", \"4f10313\")","[\"4f10313\", \"4f10314\")","[\"4f10320\", \"4f10321\")","[\"4f10321\", \"4f10322\")","[\"4f10322\", \"4f10323\")","[\"4f10323\", \"4f10324\")","[\"4f10330\", \"4f10331\")","[\"4f10331\", \"4f10332\")","[\"4f10332\", \"4f10333\")","[\"4f10333\", \"4f10334\")"]}}},{"stage":"FETCH","inputStage":{"stage":"IXSCAN","filter":{"TwoDSphereKeyInRegionExpression":true},"keyPattern":{"loc":"2dsphere"},"indexName":"loc_2dsphere","isMultiKey":false,"indexVersion":1,"direction":"forward","indexBounds":{"loc":["[\"2f1122\", \"2f1123\")","[\"2f1211\", \"2f1212\")","[\"2f1212\", \"2f1213\")","[\"2f1221\", \"2f1222\")","[\"4f1001\", \"4f1002\")","[\"4f1002\", \"4f1003\")","[\"4f1020\", \"4f1021\")","[\"4f102322\", \"4f102323\")","[\"4f1030\", \"4f1031\")","[\"4f1031\", \"4f1032\")","[\"4f1032\", \"4f1033\")","[\"4f1033\", \"4f1034\")","[\"4f1100\", \"4f1101\")","[\"4f1101\", \"4f1102\")"]}}},{"stage":"FETCH","inputStage":{"stage":"IXSCAN","filter":{"TwoDSphereKeyInRegionExpression":true},"keyPattern":{"loc":"2dsphere"},"indexName":"loc_2dsphere","isMultiKey":false,"indexVersion":1,"direction":"forward","indexBounds":{"loc":["[\"2f1122\", \"2f1123\")","[\"2f1210\", \"2f1211\")","[\"2f1211\", \"2f1212\")","[\"2f1212\", \"2f1213\")","[\"2f1213\", \"2f1214\")","[\"2f1220333\", \"2f1220333\"]","[\"2f12203333\", \"2f12203334\")","[\"2f1221\", \"2f1222\")","[\"4f1000\", \"4f1001\")","[\"4f1001\", \"4f1002\")","[\"4f1002\", \"4f1003\")","[\"4f10031\", \"4f10032\")","[\"4f10133\", \"4f10134\")","[\"4f1020\", \"4f1021\")","[\"4f1023\", \"4f1024\")","[\"4f1030\", \"4f1031\")","[\"4f103111\", \"4f103112\")","[\"4f1100\", \"4f1101\")","[\"4f1101\", \"4f1102\")"]}}}]},"rejectedPlans":[]},"executionStats":{"executionSuccess":true,"nReturned":4,"executionTimeMillis":3,"totalKeysExamined":22,"totalDocsExamined":4,"executionStages":{"stage":"GEO_NEAR_2DSPHERE","nReturned":4,"executionTimeMillisEstimate":0,"works":44,"advanced":4,"needTime":39,"needYield":0,"saveState":0,"restoreState":0,"isEOF":1,"invalidates":0,"keyPattern":{"loc":"2dsphere"},"indexName":"loc_2dsphere","searchIntervals":[{"minDistance":0,"maxDistance":13633.317181384604,"maxInclusive":false},{"minDistance":13633.317181384604,"maxDistance":40899.95154415381,"maxInclusive":false},{"minDistance":40899.95154415381,"maxDistance":95433.22026969222,"maxInclusive":false},{"minDistance":95433.22026969222,"maxDistance":204499.75772076903,"maxInclusive":false},{"minDistance":204499.75772076903,"maxDistance":422632.8326229227,"maxInclusive":false},{"minDistance":422632.8326229227,"maxDistance":858898.9824272301,"maxInclusive":false},{"minDistance":858898.9824272301,"maxDistance":1000000,"maxInclusive":true}],"inputStages":[{"stage":"FETCH","nReturned":2,"executionTimeMillisEstimate":0,"works":5,"advanced":2,"needTime":2,"needYield":0,"saveState":0,"restoreState":0,"isEOF":1,"invalidates":0,"docsExamined":2,"alreadyHasObj":0,"inputStage":{"stage":"IXSCAN","filter":{"TwoDSphereKeyInRegionExpression":true},"nReturned":2,"executionTimeMillisEstimate":0,"works":4,"advanced":2,"needTime":2,"needYield":0,"saveState":0,"restoreState":0,"isEOF":1,"invalidates":0,"keyPattern":{"loc":"2dsphere"},"indexName":"loc_2dsphere","isMultiKey":false,"indexVersion":1,"direction":"forward","indexBounds":{"loc":["[\"4f1032010\", \"4f1032010\"]","[\"4f10320102\", \"4f10320102\"]","[\"4f103201020\", \"4f103201020\"]","[\"4f1032010202\", \"4f1032010203\")","[\"4f103201021\", \"4f103201021\"]","[\"4f1032010213\", \"4f1032010213\"]","[\"4f10320102133\", \"4f10320102134\")","[\"4f103201022\", \"4f103201023\")","[\"4f103201023\", \"4f103201024\")","[\"4f10320103\", \"4f10320103\"]","[\"4f103201030\", \"4f103201030\"]","[\"4f1032010300\", \"4f1032010301\")","[\"4f1032011\", \"4f1032011\"]","[\"4f10320110\", \"4f10320110\"]","[\"4f103201101\", \"4f103201101\"]","[\"4f1032011011\", \"4f1032011011\"]","[\"4f10320110111\", \"4f10320110112\")","[\"4f10320113\", \"4f10320113\"]","[\"4f103201132\", \"4f103201133\")","[\"4f103201133\", \"4f103201134\")"]},"keysExamined":4,"dupsTested":0,"dupsDropped":0,"seenInvalidated":0,"matchTested":2}},{"stage":"FETCH","nReturned":1,"executionTimeMillisEstimate":0,"works":5,"advanced":1,"needTime":3,"needYield":0,"saveState":0,"restoreState":0,"isEOF":1,"invalidates":0,"docsExamined":1,"alreadyHasObj":0,"inputStage":{"stage":"IXSCAN","filter":{"TwoDSphereKeyInRegionExpression":true},"nReturned":1,"executionTimeMillisEstimate":0,"works":4,"advanced":1,"needTime":3,"needYield":0,"saveState":0,"restoreState":0,"isEOF":1,"invalidates":0,"keyPattern":{"loc":"2dsphere"},"indexName":"loc_2dsphere","isMultiKey":false,"indexVersion":1,"direction":"forward","indexBounds":{"loc":["[\"4f1032010\", \"4f1032010\"]","[\"4f10320100\", \"4f10320100\"]","[\"4f103201002\", \"4f103201003\")","[\"4f10320101\", \"4f10320102\")","[\"4f10320102\", \"4f10320103\")","[\"4f10320103\", \"4f10320104\")","[\"4f1032011\", \"4f1032012\")","[\"4f1032012\", \"4f1032012\"]","[\"4f10320120\", \"4f10320121\")","[\"4f1032013\", \"4f1032013\"]","[\"4f10320131\", \"4f10320132\")","[\"4f10320132\", \"4f10320132\"]","[\"4f103201321\", \"4f103201322\")"]},"keysExamined":4,"dupsTested":0,"dupsDropped":0,"seenInvalidated":0,"matchTested":1}},{"stage":"FETCH","nReturned":1,"executionTimeMillisEstimate":0,"works":5,"advanced":1,"needTime":3,"needYield":0,"saveState":0,"restoreState":0,"isEOF":1,"invalidates":0,"docsExamined":1,"alreadyHasObj":0,"inputStage":{"stage":"IXSCAN","filter":{"TwoDSphereKeyInRegionExpression":true},"nReturned":1,"executionTimeMillisEstimate":0,"works":4,"advanced":1,"needTime":3,"needYield":0,"saveState":0,"restoreState":0,"isEOF":1,"invalidates":0,"keyPattern":{"loc":"2dsphere"},"indexName":"loc_2dsphere","isMultiKey":false,"indexVersion":1,"direction":"forward","indexBounds":{"loc":["[\"4f1032002\", \"4f1032003\")","[\"4f1032003\", \"4f1032004\")","[\"4f1032010\", \"4f1032011\")","[\"4f1032011\", \"4f1032012\")","[\"4f1032012\", \"4f1032013\")","[\"4f1032013\", \"4f1032014\")","[\"4f1032020\", \"4f1032021\")","[\"4f1032021\", \"4f1032021\"]","[\"4f10320210\", \"4f10320211\")","[\"4f1032321\", \"4f1032321\"]","[\"4f10323212\", \"4f10323213\")","[\"4f1032322\", \"4f1032323\")","[\"4f1033033\", \"4f1033033\"]","[\"4f10330333\", \"4f10330334\")","[\"4f1033100\", \"4f1033101\")","[\"4f1033103\", \"4f1033104\")","[\"4f1033110\", \"4f1033110\"]","[\"4f10331100\", \"4f10331100\"]","[\"4f103311000\", \"4f103311001\")"]},"keysExamined":4,"dupsTested":0,"dupsDropped":0,"seenInvalidated":0,"matchTested":1}},{"stage":"FETCH","nReturned":0,"executionTimeMillisEstimate":0,"works":1,"advanced":0,"needTime":0,"needYield":0,"saveState":0,"restoreState":0,"isEOF":1,"invalidates":0,"docsExamined":0,"alreadyHasObj":0,"inputStage":{"stage":"IXSCAN","filter":{"TwoDSphereKeyInRegionExpression":true},"nReturned":0,"executionTimeMillisEstimate":0,"works":1,"advanced":0,"needTime":0,"needYield":0,"saveState":0,"restoreState":0,"isEOF":1,"invalidates":0,"keyPattern":{"loc":"2dsphere"},"indexName":"loc_2dsphere","isMultiKey":false,"indexVersion":1,"direction":"forward","indexBounds":{"loc":["[\"4f1032000\", \"4f1032001\")","[\"4f1032001\", \"4f1032002\")","[\"4f1032002\", \"4f1032003\")","[\"4f1032003\", \"4f1032004\")","[\"4f1032012\", \"4f1032013\")","[\"4f1032013\", \"4f1032013\"]","[\"4f10320133\", \"4f10320133\"]","[\"4f103201333\", \"4f103201333\"]","[\"4f1032013333\", \"4f1032013333\"]","[\"4f10320133333\", \"4f10320133334\")","[\"4f1032020\", \"4f1032021\")","[\"4f1032021\", \"4f1032022\")","[\"4f1032022\", \"4f1032023\")","[\"4f1032023\", \"4f1032024\")","[\"4f1032030\", \"4f1032031\")","[\"4f1032031\", \"4f1032032\")","[\"4f1032032\", \"4f1032033\")","[\"4f1032033\", \"4f1032033\"]","[\"4f10320331\", \"4f10320332\")","[\"4f1032311\", \"4f1032312\")","[\"4f1032312\", \"4f1032313\")","[\"4f1032313\", \"4f1032314\")","[\"4f1032320\", \"4f1032321\")","[\"4f1032321\", \"4f1032322\")","[\"4f1032322\", \"4f1032323\")","[\"4f1032323\", \"4f1032324\")","[\"4f1033020\", \"4f1033020\"]","[\"4f10330201\", \"4f10330201\"]","[\"4f103302011\", \"4f103302011\"]","[\"4f1033020111\", \"4f1033020112\")","[\"4f1033023\", \"4f1033024\")","[\"4f1033030\", \"4f1033031\")","[\"4f1033031\", \"4f1033032\")","[\"4f1033032\", \"4f1033033\")","[\"4f1033033\", \"4f1033034\")","[\"4f1033100\", \"4f1033101\")","[\"4f1033101\", \"4f1033102\")","[\"4f1033102\", \"4f1033103\")","[\"4f1033103\", \"4f1033104\")","[\"4f1033110\", \"4f1033111\")","[\"4f1033111\", \"4f1033112\")","[\"4f1033112\", \"4f1033112\"]","[\"4f10331120\", \"4f10331120\"]","[\"4f103311200\", \"4f103311201\")","[\"4f1033113\", \"4f1033114\")","[\"4f1033120\", \"4f1033120\"]","[\"4f10331200\", \"4f10331200\"]","[\"4f103312000\", \"4f103312000\"]","[\"4f1033120000\", \"4f1033120001\")","[\"4f1033131\", \"4f1033132\")","[\"4f1033132\", \"4f1033133\")"]},"keysExamined":1,"dupsTested":0,"dupsDropped":0,"seenInvalidated":0,"matchTested":0}},{"stage":"FETCH","nReturned":0,"executionTimeMillisEstimate":0,"works":5,"advanced":0,"needTime":4,"needYield":0,"saveState":0,"restoreState":0,"isEOF":1,"invalidates":0,"docsExamined":0,"alreadyHasObj":0,"inputStage":{"stage":"IXSCAN","filter":{"TwoDSphereKeyInRegionExpression":true},"nReturned":0,"executionTimeMillisEstimate":0,"works":4,"advanced":0,"needTime":4,"needYield":0,"saveState":0,"restoreState":0,"isEOF":1,"invalidates":0,"keyPattern":{"loc":"2dsphere"},"indexName":"loc_2dsphere","isMultiKey":false,"indexVersion":1,"direction":"forward","indexBounds":{"loc":["[\"2f1211122\", \"2f1211122\"]","[\"2f12111222\", \"2f12111223\")","[\"2f12112\", \"2f12113\")","[\"2f12121\", \"2f12122\")","[\"4f1030122\", \"4f1030122\"]","[\"4f10301222\", \"4f10301223\")","[\"4f10302\", \"4f10303\")","[\"4f10312\", \"4f10313\")","[\"4f10313\", \"4f10314\")","[\"4f10320\", \"4f10321\")","[\"4f10321\", \"4f10322\")","[\"4f10322\", \"4f10323\")","[\"4f10323\", \"4f10324\")","[\"4f10330\", \"4f10331\")","[\"4f10331\", \"4f10332\")","[\"4f10332\", \"4f10333\")","[\"4f10333\", \"4f10334\")"]},"keysExamined":4,"dupsTested":0,"dupsDropped":0,"seenInvalidated":0,"matchTested":0}},{"stage":"FETCH","nReturned":0,"executionTimeMillisEstimate":0,"works":5,"advanced":0,"needTime":4,"needYield":0,"saveState":0,"restoreState":0,"isEOF":1,"invalidates":0,"docsExamined":0,"alreadyHasObj":0,"inputStage":{"stage":"IXSCAN","filter":{"TwoDSphereKeyInRegionExpression":true},"nReturned":0,"executionTimeMillisEstimate":0,"works":4,"advanced":0,"needTime":4,"needYield":0,"saveState":0,"restoreState":0,"isEOF":1,"invalidates":0,"keyPattern":{"loc":"2dsphere"},"indexName":"loc_2dsphere","isMultiKey":false,"indexVersion":1,"direction":"forward","indexBounds":{"loc":["[\"2f1122\", \"2f1123\")","[\"2f1211\", \"2f1212\")","[\"2f1212\", \"2f1213\")","[\"2f1221\", \"2f1222\")","[\"4f1001\", \"4f1002\")","[\"4f1002\", \"4f1003\")","[\"4f1020\", \"4f1021\")","[\"4f102322\", \"4f102323\")","[\"4f1030\", \"4f1031\")","[\"4f1031\", \"4f1032\")","[\"4f1032\", \"4f1033\")","[\"4f1033\", \"4f1034\")","[\"4f1100\", \"4f1101\")","[\"4f1101\", \"4f1102\")"]},"keysExamined":4,"dupsTested":0,"dupsDropped":0,"seenInvalidated":0,"matchTested":0}},{"stage":"FETCH","nReturned":0,"executionTimeMillisEstimate":0,"works":1,"advanced":0,"needTime":0,"needYield":0,"saveState":0,"restoreState":0,"isEOF":1,"invalidates":0,"docsExamined":0,"alreadyHasObj":0,"inputStage":{"stage":"IXSCAN","filter":{"TwoDSphereKeyInRegionExpression":true},"nReturned":0,"executionTimeMillisEstimate":0,"works":1,"advanced":0,"needTime":0,"needYield":0,"saveState":0,"restoreState":0,"isEOF":1,"invalidates":0,"keyPattern":{"loc":"2dsphere"},"indexName":"loc_2dsphere","isMultiKey":false,"indexVersion":1,"direction":"forward","indexBounds":{"loc":["[\"2f1122\", \"2f1123\")","[\"2f1210\", \"2f1211\")","[\"2f1211\", \"2f1212\")","[\"2f1212\", \"2f1213\")","[\"2f1213\", \"2f1214\")","[\"2f1220333\", \"2f1220333\"]","[\"2f12203333\", \"2f12203334\")","[\"2f1221\", \"2f1222\")","[\"4f1000\", \"4f1001\")","[\"4f1001\", \"4f1002\")","[\"4f1002\", \"4f1003\")","[\"4f10031\", \"4f10032\")","[\"4f10133\", \"4f10134\")","[\"4f1020\", \"4f1021\")","[\"4f1023\", \"4f1024\")","[\"4f1030\", \"4f1031\")","[\"4f103111\", \"4f103112\")","[\"4f1100\", \"4f1101\")","[\"4f1101\", \"4f1102\")"]},"keysExamined":1,"dupsTested":0,"dupsDropped":0,"seenInvalidated":0,"matchTested":0}}]},"allPlansExecution":[]},"serverInfo":{"host":"siyuan-mbp","port":27017,"version":"3.1.0-pre-","gitVersion":"ed108dccf043a13e1eed08dafc6c9eb793094b34"},"ok":1} 
      </textarea>
      <button id="show_button" type="submit" class="btn btn-primary">Show<span class="glyphicon glyphicon-map-marker"/></button>
      <button id="prev_button" type="submit" class="btn btn-primary">Prev Stage</button>
      <button id="next_button" type="submit" class="btn btn-primary">Next Stage</button>
    </div>

    <div id="map-canvas"></div>
    <div id="drop-container"><div id="drop-silhouette"></div></div>
  </body>
</html>
