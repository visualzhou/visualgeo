<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <title>Visualize MongoDB Geo Query Explain</title>
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
      #map-canvas { 
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
      }
      #controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        max-width: 600px;
        resize: both;
        overflow: auto;
      }
      #explain_text {
        width: 100%;
        min-width: 300px;
        min-height: 80px;
        margin-bottom: 10px;
        resize: both;
        box-sizing: border-box;
      }
      #drop-container {
        display: none;
        height: 100%;
        width: 100%;
        position: absolute;
        z-index: 1;
        top: 0px;
        left: 0px;
        padding: 20px;
        background-color: rgba(100, 100, 100, 0.5);
      }
      #drop-silhouette {
        color: white;
        border: white dashed 8px;
        height: calc(100% - 56px);
        width: calc(100% - 56px);
        background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAAXNSR0IArs4c6QAAAAZiS0dEAGQAZABkkPCsTwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB90LHAIvICWdsKwAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAACdklEQVR42u3csU7icBzA8Xp3GBMSeRITH8JHMY7cRMvmVmXoE9TAcJubhjD4ApoiopgqDMWAKAgIcSAiCfxuwhwROVJbkPD9rP23ob8vpZCQKgoAAAAAAAAAAPDYyiK/eNM05bNtr6+vSjgcXiHxDMkE1WpVFvGcfpCVICAIQUAQgoAgBAFBCAKCgCAEAUEIAoIQBAQhCAgCghAEBCEICEIQEIQgIAgIQhAQhCAgCEFAEIKAICAIQUAQgoAgBAFBCDIzhmFINBo9/K6D0XVddnd3ZaneDY7jSCqVcn3SfjyeKRKJbJ2dnYllWbKUl2i5XJaXlxdJJBIy7yDHx8fy9vYm6XR6OWMM3d/fi4hIqVSSWCwmsw5ycHAgrVZLRETOz8+XO8ZQpVJ5H2Y6nRZN0/b9DqLruhSLxfd9MpkMMT6L0uv1JJlMih9BhveJwWDwvv7i4oIY4zw8PIwMtt1uSzweF6+CHB0dSbfbHVmbzWaJMcnj4+OHAd/d3cne3p64DWKapjw/P39Yd3l5SYxpVKvVsYO2LEtUVd2ZNoiu6+I4ztg1V1dXxPAiSq/Xk5OTk0k9pNVqyenp6ch94l+5XI4YbtRqNfHa9fX1t43xcwGa/Nnc3PwdDAY9OZht28rGxgZPvP6KSCSy9fT09OUrw7ZtPqa8jFKv113HuLm5IYbXVFXdcRPl9vaWGH5GaTQaU8fI5/PE8JumafvNZvO/MQqFAjFmJRqNHk6Ksqgx5vr1zzAM2d7edr3/6uqqsra2NnZbp9NR+v2+62OHQqG5zObXPIMEAgFlfX3dl2N79btl1viTA0FAEIKAIAQBAAAAAAAAsMz+Ai1bUgo6ebm8AAAAAElFTkSuQmCC');
        background-repeat: no-repeat;
        background-position: center;
      }
    </style>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="text/javascript">
      // Set up Module configuration BEFORE loading s2.js
      var Module = {
        onRuntimeInitialized: function() {
          console.log("S2 Module initialized successfully");
          window.s2ModuleReady = true;
        }
      };
      window.s2ModuleReady = false;
    </script>
    <script type="text/javascript" src="/static/js/s2.js"></script>
    <script type="text/javascript">
/* Map functions */

var map;
var nearExplain;
var geoJsonLayers = []; // Store all GeoJSON layers for clearing

function initMap() {
  // set up the map with Leaflet
  map = L.map('map-canvas').setView([0, 0], 2);
  
  // Add OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors',
    maxZoom: 19
  }).addTo(map);
}

function parseRelaxedJSON(jsonString) {
  // Strip out MongoDB-specific types
  let cleaned = jsonString;
  
  // Remove $clusterTime object (which has nested structure)
  // This regex handles one level of nesting for the signature object
  cleaned = cleaned.replace(/['"]?\$clusterTime['"]?\s*:\s*\{(?:[^{}]|\{[^{}]*\})*\}\s*,?/g, '');
  
  // Remove Binary.createFromBase64(...) and replace with a string
  // cleaned = cleaned.replace(/Binary\.createFromBase64\(\s*'([^']*)',\s*\d+\s*\)/g, '"$1"');
  // cleaned = cleaned.replace(/Binary\.createFromBase64\(\s*"([^"]*)",\s*\d+\s*\)/g, '"$1"');
  
  // Remove Timestamp(...) and replace with the inner object
  cleaned = cleaned.replace(/(Timestamp\([^)]*\))/g, '"{$1}"');
  
  // Remove Long(...) and replace with the inner value
  cleaned = cleaned.replace(/Long\(\s*'([^']*)'\s*\)/g, '"$1"');
  
  // Add quotes to unquoted keys - match key: value patterns
  // This regex looks for word characters followed by colon, ensuring it's not already quoted
  cleaned = cleaned.replace(/([{,]\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)\s*:/g, '$1"$2":');

  // Replace single quotes with double quotes.
  cleaned = cleaned.replace(/'/g, '"');
  
  return JSON.parse(cleaned);
}

function loadGeoJsonString(geoString) {
  var geojson = parseRelaxedJSON(geoString);
  return loadGeoJson(geojson);
}

function loadGeoJson(geometry, properties) {
  var feature = {
    type: "Feature",
    id: 0,
    geometry: geometry,
    properties: properties || {},
  }
  
  // Determine style based on properties
  var style = {
    fillColor: properties && properties.cellUnion ? 'grey' : (properties && properties.covering ? 'blue' : 'red'),
    fillOpacity: properties && properties.cellUnion ? 0.1 : (properties && properties.covering ? 0.3 : 0.2),
    color: properties && properties.cellUnion ? 'grey' : (properties && properties.covering ? 'blue' : 'red'),
    weight: properties && properties.covering ? 2 : 1
  };
  
  var layer = L.geoJSON(feature, {
    style: style
  }).addTo(map);
  
  geoJsonLayers.push(layer);
  zoom();
  return layer;
}

/**
 * Update a map's viewport to fit all geometry layers
 */
function zoom() {
  if (geoJsonLayers.length === 0) return;
  
  var group = L.featureGroup(geoJsonLayers);
  if (nearExplain && nearExplain.drawing) {
    nearExplain.drawing.forEach(function(circle) {
      group.addLayer(circle);
    });
  }
  
  try {
    var bounds = group.getBounds();
    
    // Check if bounds are valid (not infinite or spanning the whole world)
    var sw = bounds.getSouthWest();
    var ne = bounds.getNorthEast();
    var latSpan = Math.abs(ne.lat - sw.lat);
    var lngSpan = Math.abs(ne.lng - sw.lng);
    
    // If bounds are suspiciously large (e.g., spanning more than 90 degrees),
    // it might be due to large S2 cells in the covering. Use a more conservative zoom.
    if (latSpan > 90 || lngSpan > 90) {
      console.warn("Bounds are very large, using conservative zoom level");
      // Calculate center
      var centerLat = (ne.lat + sw.lat) / 2;
      var centerLng = (ne.lng + sw.lng) / 2;
      map.setView([centerLat, centerLng], 4);
    } else {
      // Add padding to prevent over-zooming on small geometries
      map.fitBounds(bounds, {
        padding: [50, 50],
        maxZoom: 18  // Prevent excessive zoom for very small areas
      });
    }
  } catch (e) {
    console.error("Error fitting bounds:", e);
    // Fallback to a reasonable default view if bounds fail
    map.setView([0, 0], 2);
  }
}


/* DOM (drag/drop) functions */

function initEvents() {
  // set up the drag & drop events
  var mapContainer = document.getElementById('map-canvas');
  var dropContainer = document.getElementById('drop-container');

  // first on common events
  [mapContainer, dropContainer].forEach(function(container) {
    container.addEventListener('drop', handleDrop, false);
    container.addEventListener('dragover', showPanel, false);
  });

  // then map-specific events
  mapContainer.addEventListener('dragstart', showPanel, false);
  mapContainer.addEventListener('dragenter', showPanel, false);

  // then the overlay specific events (since it only appears once drag starts)
  dropContainer.addEventListener('dragend', hidePanel, false);
  dropContainer.addEventListener('dragleave', hidePanel, false);
}

function showPanel(e) {
  e.stopPropagation();
  e.preventDefault();
  document.getElementById('drop-container').style.display = 'block';
  return false;
}

function hidePanel(e) {
  document.getElementById('drop-container').style.display = 'none';
}

function handleDrop(e) {
  e.preventDefault();
  e.stopPropagation();
  hidePanel(e);

  var files = e.dataTransfer.files;
  if (files.length) {
    // process file(s) being dropped
    // grab the file data from each file
    for (var i = 0, file; file = files[i]; i++) {
      var reader = new FileReader();
      reader.onload = function(e) {
        loadGeoJsonString(e.target.result);
      };
      reader.onerror = function(e) {
        console.error('reading failed');
      };
      reader.readAsText(file);
    }
  } else {
    // process non-file (e.g. text or html) content being dropped
    // grab the plain text version of the data
    var plainText = e.dataTransfer.getData('text/plain');
    if (plainText) {
      loadGeoJsonString(plainText);
    }
  }

  // prevent drag event from bubbling further
  return false;
}

// { type: "Annulus", center: [lng, lat], min: 0, max: 10 /* meters */ }

function ShapeAndCovering(id) {
  // query GeoJSON or Annnulas
  this.shape = null;
  // Array of GeoJSON, each polygon represents a cell
  this.covering = [];
  this.id = id;
  // Features to diplay
}

function get2dSphereField(stage) {
  if (stage.stage != "IXSCAN") return null;
  keyPattern = stage.keyPattern;
  if (keyPattern == null) return null;
  var res = null;
  Object.getOwnPropertyNames(keyPattern).forEach(function(field) {
    if (keyPattern[field] == "2dsphere") {
      res = field;
    }})

  return res;
}

function findField(node, expectedField) {
  res = null;
  if (node instanceof Array) {
    for (let entry of node) {
      res = findField(entry, expectedField);
      if (res != null) {
        return res;
      }
    }
  }
  if (node === null || typeof node !== 'object') {
    return null;
  }

  nodeKeys = Object.getOwnPropertyNames(node);
  for (i = 0; i < nodeKeys.length; i++) {
    field = nodeKeys[i];
    if (field == expectedField) {
      return node[field];
    } else {
      res = findField(node[field], expectedField);
      if (res != null) {
        return res;
      }
    }
  }
  return res;
}


// bounds is the array of string
// [
//   "[\"0f1332332\", \"0f1332332\"]",
//   "[\"0f13323323\", \"0f13323323\"]",
// ]
function translateIndexBoundsToCellIds(bounds) {
  // Only show intervals, no points
  var boundRe = /\W(.*),\s*(.*)\W$/;
  var cellBounds = [];
  bounds.forEach(function(bound) {
    var m = boundRe.exec(bound);
    // TODO: Given that finest query level is 23, if start == end, that must be a point query.
    if (m[1] !== m[2]) cellBounds.push({start: m[1], end: m[2]});
  });
  var cellIds = [];
  // cellBounds ["0f1332332", "0f13323323"]
  cellBounds.forEach(function(cell) {
    if (cell.start.startsWith('"')) {
      // '"0f1332332"'
      cellIds.push(cell.start.slice(1, -1));
    } else {
      // '563805707163664385'
      var cellId = Module.getCellIdFromMinMax(cell.start, cell.end);
      cellIds.push(cellId);
    }
  });
  return cellIds;
}

function translateCellIdToGeoJSON(cellId) {
    var points = Module.getPolygonFromCellId(cellId);
    var loop = [];
    for (var i = 0; i < points.size(); i++) {
      // The last LngLat is the same with the first one.
      var ll = points.get(i % points.size());
      loop.push([ll.lng, ll.lat]);
    }
    return { type: "Polygon", coordinates: [loop]};
}

function clearMap() {
  // Remove all GeoJSON layers
  geoJsonLayers.forEach(function(layer) {
    map.removeLayer(layer);
  });
  geoJsonLayers = [];
  
  // Remove circle drawings
  if (nearExplain && nearExplain.drawing) {
    nearExplain.drawing.forEach(function(circle) {
      map.removeLayer(circle);
    });
    nearExplain.drawing = [];
  }
}

function showGeoQueryExplain(shapeAndCovering) {
  clearMap();
  loadGeoJson(shapeAndCovering.shape);
  shapeAndCovering.covering.forEach(function(cellId) {
    var polygon = translateCellIdToGeoJSON(cellId);
    loadGeoJson(polygon, {covering: true});
  });
}

function parseGeoQueryExplain(explain) {
  var execStages = explain.executionStats.executionStages;
  var stage = findStage(execStages, function(st){return get2dSphereField(st) != null;});

  if (stage == null) {
    console.log("No geo stage found in explain");
    return;
  }

  var geoField = get2dSphereField(stage);
  
  // Convert stage.indexBounds
  var covering = translateIndexBoundsToCellIds(stage.indexBounds[geoField]);

  var shapeAndCovering = new ShapeAndCovering(0);
  shapeAndCovering.covering = covering;
  shapeAndCovering.shape = findField(explain.queryPlanner.parsedQuery, "$geometry");
  showGeoQueryExplain(shapeAndCovering);
}


// ----------- Geo Near -----------
// { type: "Annulus", center: [lng, lat], min: 0, max: 10 /* meters */ }
function Annulus(center, min, max) {
  this.type = "Annulus";
  this.center = center;
  this.min = min;
  this.max = max;

}

function NearExplain() {
  this.stages = [];
  this.rootStage = null;
  this.curStage = 0;
  this.drawing = [];
}

function drawCircle(center, radius) {
  // Leaflet uses [lat, lng] order, center is [lng, lat]
  var circle = L.circle([center[1], center[0]], {
    color: '#FF0000',
    opacity: 0.8,
    weight: 4,
    fillColor: '#FF0000',
    fillOpacity: 0,
    radius: radius  // radius in meters
  }).addTo(map);
  
  nearExplain.drawing.push(circle);
  geoJsonLayers.push(circle);  // Also add to geoJsonLayers for bounds calculation
}

function showGeoNearExplain() {
  clearMap();
  
  nearExplain.stages[nearExplain.curStage].coverings.forEach(function(cellId) {
    var polygon = translateCellIdToGeoJSON(cellId);
    loadGeoJson(polygon, {covering: true});
  });

  // Draw cell union
  cells = new Module.VectorString();
  for (var i = 0; i < nearExplain.curStage; i++) {
    var stage = nearExplain.stages[i];
    stage.coverings.forEach(function(cellId) {
      cells.push_back(cellId);
    });
  }
  cells = Module.getCellUnion(cells);
  for (var i = 0; i < cells.size(); i++) {
    var polygon = translateCellIdToGeoJSON(cells.get(i));
    loadGeoJson(polygon, {cellUnion: true});
  }
  
  // Styles are now handled in loadGeoJson based on properties

  var annulus = nearExplain.stages[nearExplain.curStage].shape;
  drawCircle(annulus.center, annulus.min);
  drawCircle(annulus.center, annulus.max);
  
  zoom();
}

/*
Recursively searches stages, returning the shallowest which satisfies
the condition function
@param {Object|Array} root_stage
@param {Function} condition
*/
function findStage(root_stage, condition){
  var q = [];
  if(typeof(root_stage) == "array"){
    q = q.concat(root_stage);
  } else {
    q.push(root_stage);
  }
  while(q.length > 0){
    var stage = q.shift();
    if(condition.call(window, stage)){
      return stage;
    } else {
      if(stage.hasOwnProperty("inputStage")){
        q.push(stage.inputStage);
      } else if(stage.hasOwnProperty("inputStages")){
        q = q.concat(stage.inputStages);
      }
    }
  }
  return null;
}

function parseGeoNearExplain(explain) {
  var execStages = explain.executionStats.executionStages;
  var rootStage = findStage(execStages, function(st){return st.stage == "GEO_NEAR_2DSPHERE";});
  if (!rootStage) {
    return null;
  }

  nearExplain = new NearExplain();
  nearExplain.rootStage = rootStage;

  // Get center
  var nearQueryPred = findField(explain.queryPlanner.parsedQuery, "$near");
  if (nearQueryPred == null) {
    nearQueryPred = findField(explain.queryPlanner.parsedQuery, "$nearSphere");
  }
  if (nearQueryPred == null) {
    console.log("Could not find geo predicate within: ", explain.queryPlanner.parsedQuery)
  }
  var center;
  if (nearQueryPred["$geometry"]) {
    center = nearQueryPred["$geometry"].coordinates;
  } else {
    center = nearQueryPred;
  }

  // Search annulus
  rootStage.searchIntervals.forEach(function(interval, idx) {
    var annulus = new Annulus(center, interval.minDistance, interval.maxDistance);
    var shapeAndCovering = new ShapeAndCovering(idx);
    shapeAndCovering.shape = annulus;
    nearExplain.stages.push(shapeAndCovering);
  });

  var curStage = 0;

  // Get initial indexBounds to find the fieldName used in the query
  var indexBoundsStage = findStage(rootStage, function(st){return st.hasOwnProperty("indexBounds"); });
  
  if (!indexBoundsStage) {
    console.error("No indexBounds found in rootStage");
    showGeoNearExplain();
    return nearExplain;
  }
  
  var indexBounds = indexBoundsStage["indexBounds"];
  
  // Find the geo field name using get2dSphereField, or by finding bounds that look like S2 cell IDs
  var fieldName = get2dSphereField(indexBoundsStage);
  if (!fieldName) {
    // Fallback: find the field with S2-style bounds (strings that look like cell IDs, not booleans)
    var fieldNames = Object.getOwnPropertyNames(indexBounds);
    for (var i = 0; i < fieldNames.length; i++) {
      var bounds = indexBounds[fieldNames[i]];
      if (bounds && bounds.length > 0 && typeof bounds[0] === 'string' && bounds[0].length > 10 && bounds[0].indexOf('[') !== 0) {
        fieldName = fieldNames[i];
        break;
      }
    }
  }
  
  if (!fieldName) {
    console.error("Could not find geo field in indexBounds");
    showGeoNearExplain();
    return nearExplain;
  }

  // Translate S2 GeoHash to GeoJSON polygons
  if(rootStage.hasOwnProperty("inputStages")){
      for (var i = 0; i < rootStage.inputStages.length; i++) {
        var stageWithBounds = findStage(rootStage.inputStages[i], function(st){return st.hasOwnProperty("indexBounds"); });
        if (stageWithBounds) {
          indexBounds = stageWithBounds["indexBounds"];
          var bounds = indexBounds[fieldName];
          nearExplain.stages[i].coverings = translateIndexBoundsToCellIds(bounds);
        }
      }
  } else if(rootStage.hasOwnProperty("inputStage")){
      nearExplain.stages[0].coverings = translateIndexBoundsToCellIds(indexBounds[fieldName]);
  }

  showGeoNearExplain();

  return nearExplain;
}

function parseExplain(explain) {
  clearMap();
  nearExplain = null;
  var isNear = parseGeoNearExplain(explain);
  if (isNear) return;
  parseGeoQueryExplain(explain);
}

// ----------- Geo Near -----------

window.addEventListener('load', function() {
  initMap();
  initEvents();
});

$(document).ready(function() {
   $('#show_button').click(function() {
      try {
        // Check if S2 Module is ready
        if (typeof Module === 'undefined' || !window.s2ModuleReady) {
          alert("S2 Module is still loading. Please wait a moment and try again.");
          console.log("Module defined:", typeof Module !== 'undefined', "Module ready:", window.s2ModuleReady);
          return;
        }
        
        var jsonText = $('#explain_text').val();
        console.log("Parsing JSON of length:", jsonText.length);
        var explainData = parseRelaxedJSON(jsonText);
        console.log("JSON parsed successfully");
        parseExplain(explainData);
      } catch (e) {
        console.error("Error details:", e);
        alert("Error: " + e.name + ": " + e.message + "\n\nCheck the console for more details.");
      }
   });

   $('#prev_button').click(function() {
      if (nearExplain == null) {
        console.log("nearExplain is null");
        return;
      }

      if (nearExplain.curStage > 0) nearExplain.curStage--;
      showGeoNearExplain();
   });


   $('#next_button').click(function() {
      if (nearExplain == null) {
        console.log("nearExplain is null");
        return;
      }

      if (nearExplain.curStage < nearExplain.stages.length - 1) nearExplain.curStage++;
      showGeoNearExplain();
   });
});

    </script>
  </head>
  <body>
    <div id="controls">
      <textarea class="form-control" id="explain_text" cols="30" rows="3">
        {
          "explainVersion" : "1",
          "queryPlanner" : {
                  "namespace" : "test.batchMergeData",
                  "parsedQuery" : {
                          "$and" : [
                                  {
                                          "location.coming_soon" : {
                                                  "$eq" : false
                                          }
                                  },
                                  {
                                          "location.evseList.evsePowerLevel" : {
                                                  "$eq" : "Ultra Fast"
                                          }
                                  },
                                  {
                                          "location.evseList.plugNCharge" : {
                                                  "$eq" : true
                                          }
                                  },
                                  {
                                          "location.accessTypeId" : {
                                                  "$in" : [
                                                          -2,
                                                          -1,
                                                          1
                                                  ]
                                          }
                                  },
                                  {
                                          "location.evseList.chargeConnectorList.connector" : {
                                                  "$in" : [
                                                          2,
                                                          6,
                                                          7,
                                                          8,
                                                          13,
                                                          21
                                                  ]
                                          }
                                  },
                                  {
                                          "coordinates" : {
                                                  "$near" : {
                                                          "$geometry" : {
                                                                  "type" : "Point",
                                                                  "coordinates" : [
                                                                          7.481319978833198,
                                                                          51.45842169665437
                                                                  ]
                                                          },
                                                          "$maxDistance" : 72000,
                                                          "$minDistance" : 24000
                                                  }
                                          }
                                  }
                          ]
                  },
                  "indexFilterSet" : false,
                  "queryHash" : "547EF581",
                  "planCacheShapeHash" : "547EF581",
                  "planCacheKey" : "0AD2C1CA",
                  "optimizationTimeMillis" : 2,
                  "maxIndexedOrSolutionsReached" : false,
                  "maxIndexedAndSolutionsReached" : false,
                  "maxScansToExplodeReached" : false,
                  "prunedSimilarIndexes" : false,
                  "winningPlan" : {
                          "isCached" : false,
                          "stage" : "PROJECTION_SIMPLE",
                          "transformBy" : {
                                  "position" : 1
                          },
                          "inputStage" : {
                                  "stage" : "FETCH",
                                  "filter" : {
                                          "$and" : [
                                                  {
                                                          "location.evseList.chargeConnectorList.connector" : {
                                                                  "$in" : [
                                                                          2,
                                                                          6,
                                                                          7,
                                                                          8,
                                                                          13,
                                                                          21
                                                                  ]
                                                          }
                                                  },
                                                  {
                                                          "location.evseList.evsePowerLevel" : {
                                                                  "$eq" : "Ultra Fast"
                                                          }
                                                  }
                                          ]
                                  },
                                  "inputStage" : {
                                          "stage" : "GEO_NEAR_2DSPHERE",
                                          "keyPattern" : {
                                                  "location.coming_soon" : 1,
                                                  "location.accessTypeId" : 1,
                                                  "location.evseList.plugNCharge" : 1,
                                                  "location.evseList.evsePowerLevel" : 1,
                                                  "location.evseList.chargeConnectorList.connector" : 1,
                                                  "coordinates" : "2dsphere"
                                          },
                                          "indexName" : "location.coming_soon_1_location.accessTypeId_1_location.evseList.plugNCharge_1_location.evseList.evsePowerLevel_1_location.evseList.chargeConnectorList.connector_1_coordinates_2dsphere",
                                          "indexVersion" : 2,
                                          "inputStages" : [
                                                  {
                                                          "stage" : "FETCH",
                                                          "inputStage" : {
                                                                  "stage" : "IXSCAN",
                                                                  "keyPattern" : {
                                                                          "location.coming_soon" : 1,
                                                                          "location.accessTypeId" : 1,
                                                                          "location.evseList.plugNCharge" : 1,
                                                                          "location.evseList.evsePowerLevel" : 1,
                                                                          "location.evseList.chargeConnectorList.connector" : 1,
                                                                          "coordinates" : "2dsphere"
                                                                  },
                                                                  "indexName" : "location.coming_soon_1_location.accessTypeId_1_location.evseList.plugNCharge_1_location.evseList.evsePowerLevel_1_location.evseList.chargeConnectorList.connector_1_coordinates_2dsphere",
                                                                  "isMultiKey" : true,
                                                                  "multiKeyPaths" : {
                                                                          "location.coming_soon" : [ ],
                                                                          "location.accessTypeId" : [ ],
                                                                          "location.evseList.plugNCharge" : [
                                                                                  "location.evseList"
                                                                          ],
                                                                          "location.evseList.evsePowerLevel" : [
                                                                                  "location.evseList"
                                                                          ],
                                                                          "location.evseList.chargeConnectorList.connector" : [
                                                                                  "location.evseList",
                                                                                  "location.evseList.chargeConnectorList"
                                                                          ],
                                                                          "coordinates" : [ ]
                                                                  },
                                                                  "isUnique" : false,
                                                                  "isSparse" : false,
                                                                  "isPartial" : false,
                                                                  "indexVersion" : 2,
                                                                  "direction" : "forward",
                                                                  "indexBounds" : {
                                                                          "location.coming_soon" : [
                                                                                  "[false, false]"
                                                                          ],
                                                                          "location.accessTypeId" : [
                                                                                  "[-2.0, -2.0]",
                                                                                  "[-1.0, -1.0]",
                                                                                  "[1.0, 1.0]"
                                                                          ],
                                                                          "location.evseList.plugNCharge" : [
                                                                                  "[true, true]"
                                                                          ],
                                                                          "location.evseList.evsePowerLevel" : [
                                                                                  "[MinKey, MaxKey]"
                                                                          ],
                                                                          "location.evseList.chargeConnectorList.connector" : [
                                                                                  "[MinKey, MaxKey]"
                                                                          ],
                                                                          "coordinates" : [
                                                                                  "[5116089176692883456, 5116089176692883456]",
                                                                                  "[5165628772593958912, 5165628772593958912]",
                                                                                  "[5168091678640177152, 5168091678640177152]",
                                                                                  "[5168091678640177153, 5168100474733199359]",
                                                                                  "[5168109270826221568, 5168109270826221568]",
                                                                                  "[5168109270826221569, 5168118066919243775]",
                                                                                  "[5168118066919243777, 5168126863012265983]",
                                                                                  "[5168126863012265985, 5168162047384354815]",
                                                                                  "[5168162047384354816, 5168162047384354816]",
                                                                                  "[5168162047384354817, 5168170843477377023]",
                                                                                  "[5168170843477377025, 5168179639570399231]",
                                                                                  "[5168179639570399232, 5168179639570399232]",
                                                                                  "[5168201629802954752, 5168201629802954752]",
                                                                                  "[5168203828826210305, 5168206027849465855]",
                                                                                  "[5168206027849465857, 5168214823942488063]",
                                                                                  "[5168214823942488064, 5168214823942488064]",
                                                                                  "[5168214823942488065, 5168223620035510271]",
                                                                                  "[5168232416128532480, 5168232416128532480]",
                                                                                  "[5168232416128532481, 5168241212221554687]",
                                                                                  "[5168241212221554689, 5168250008314576895]",
                                                                                  "[5168250008314576896, 5168250008314576896]",
                                                                                  "[5168250008314576897, 5168252207337832447]",
                                                                                  "[5168254406361088000, 5168254406361088000]",
                                                                                  "[5168258804407599105, 5168267600500621311]",
                                                                                  "[5168267600500621313, 5168276396593643519]",
                                                                                  "[5168276396593643521, 5168285192686665727]",
                                                                                  "[5168285192686665728, 5168285192686665728]",
                                                                                  "[5168285192686665729, 5168293988779687935]",
                                                                                  "[5168296187802943489, 5168298386826199039]",
                                                                                  "[5168298386826199040, 5168298386826199040]",
                                                                                  "[5168338519000612865, 5168339068756426751]",
                                                                                  "[5168339068756426752, 5168339068756426752]",
                                                                                  "[5168342367291310080, 5168342367291310080]",
                                                                                  "[5168344566314565633, 5168346765337821183]",
                                                                                  "[5168346765337821185, 5168355561430843391]",
                                                                                  "[5168355561430843392, 5168355561430843392]",
                                                                                  "[5168373153616887808, 5168373153616887808]",
                                                                                  "[5169006472314486784, 5169006472314486784]",
                                                                                  "[5170132372221329408, 5170132372221329408]"
                                                                          ]
                                                                  }
                                                          }
                                                  },
                                                  {
                                                          "stage" : "FETCH",
                                                          "inputStage" : {
                                                                  "stage" : "IXSCAN",
                                                                  "keyPattern" : {
                                                                          "location.coming_soon" : 1,
                                                                          "location.accessTypeId" : 1,
                                                                          "location.evseList.plugNCharge" : 1,
                                                                          "location.evseList.evsePowerLevel" : 1,
                                                                          "location.evseList.chargeConnectorList.connector" : 1,
                                                                          "coordinates" : "2dsphere"
                                                                  },
                                                                  "indexName" : "location.coming_soon_1_location.accessTypeId_1_location.evseList.plugNCharge_1_location.evseList.evsePowerLevel_1_location.evseList.chargeConnectorList.connector_1_coordinates_2dsphere",
                                                                  "isMultiKey" : true,
                                                                  "multiKeyPaths" : {
                                                                          "location.coming_soon" : [ ],
                                                                          "location.accessTypeId" : [ ],
                                                                          "location.evseList.plugNCharge" : [
                                                                                  "location.evseList"
                                                                          ],
                                                                          "location.evseList.evsePowerLevel" : [
                                                                                  "location.evseList"
                                                                          ],
                                                                          "location.evseList.chargeConnectorList.connector" : [
                                                                                  "location.evseList",
                                                                                  "location.evseList.chargeConnectorList"
                                                                          ],
                                                                          "coordinates" : [ ]
                                                                  },
                                                                  "isUnique" : false,
                                                                  "isSparse" : false,
                                                                  "isPartial" : false,
                                                                  "indexVersion" : 2,
                                                                  "direction" : "forward",
                                                                  "indexBounds" : {
                                                                          "location.coming_soon" : [
                                                                                  "[false, false]"
                                                                          ],
                                                                          "location.accessTypeId" : [
                                                                                  "[-2.0, -2.0]",
                                                                                  "[-1.0, -1.0]",
                                                                                  "[1.0, 1.0]"
                                                                          ],
                                                                          "location.evseList.plugNCharge" : [
                                                                                  "[true, true]"
                                                                          ],
                                                                          "location.evseList.evsePowerLevel" : [
                                                                                  "[MinKey, MaxKey]"
                                                                          ],
                                                                          "location.evseList.chargeConnectorList.connector" : [
                                                                                  "[MinKey, MaxKey]"
                                                                          ],
                                                                          "coordinates" : [
                                                                                  "[5116089176692883456, 5116089176692883456]",
                                                                                  "[5165628772593958912, 5165628772593958912]",
                                                                                  "[5167950941151821824, 5167950941151821824]",
                                                                                  "[5167950941151821825, 5167986125523910655]",
                                                                                  "[5167986125523910657, 5167994921616932863]",
                                                                                  "[5168003717709955072, 5168003717709955072]",
                                                                                  "[5168021309895999489, 5168056494268088319]",
                                                                                  "[5168056494268088321, 5168091678640177151]",
                                                                                  "[5168091678640177152, 5168091678640177152]",
                                                                                  "[5168100474733199361, 5168109270826221567]",
                                                                                  "[5168109270826221568, 5168109270826221568]",
                                                                                  "[5168162047384354816, 5168162047384354816]",
                                                                                  "[5168232416128532480, 5168232416128532480]",
                                                                                  "[5168250008314576896, 5168250008314576896]",
                                                                                  "[5168252207337832449, 5168254406361087999]",
                                                                                  "[5168254406361088000, 5168254406361088000]",
                                                                                  "[5168254406361088001, 5168256605384343551]",
                                                                                  "[5168256605384343553, 5168258804407599103]",
                                                                                  "[5168285192686665728, 5168285192686665728]",
                                                                                  "[5168293988779687937, 5168296187802943487]",
                                                                                  "[5168298386826199040, 5168298386826199040]",
                                                                                  "[5168298386826199041, 5168300585849454591]",
                                                                                  "[5168300585849454593, 5168302784872710143]",
                                                                                  "[5168302784872710145, 5168337969244798975]",
                                                                                  "[5168337969244798977, 5168338519000612863]",
                                                                                  "[5168339068756426752, 5168339068756426752]",
                                                                                  "[5168339068756426753, 5168339618512240639]",
                                                                                  "[5168339618512240641, 5168340168268054527]",
                                                                                  "[5168340168268054529, 5168342367291310079]",
                                                                                  "[5168342367291310080, 5168342367291310080]",
                                                                                  "[5168342367291310081, 5168344566314565631]",
                                                                                  "[5168355561430843392, 5168355561430843392]",
                                                                                  "[5168355561430843393, 5168364357523865599]",
                                                                                  "[5168364357523865601, 5168373153616887807]",
                                                                                  "[5168373153616887808, 5168373153616887808]",
                                                                                  "[5168487502826176513, 5168496298919198719]",
                                                                                  "[5168496298919198720, 5168496298919198720]",
                                                                                  "[5168513891105243136, 5168513891105243136]",
                                                                                  "[5168724997337776128, 5168724997337776128]",
                                                                                  "[5168936103570309120, 5168936103570309120]",
                                                                                  "[5168936103570309121, 5168971287942397951]",
                                                                                  "[5168971287942397953, 5169006472314486783]",
                                                                                  "[5169006472314486784, 5169006472314486784]",
                                                                                  "[5169006472314486785, 5169015268407508991]",
                                                                                  "[5169024064500531200, 5169024064500531200]",
                                                                                  "[5169076841058664448, 5169076841058664448]",
                                                                                  "[5169287947291197440, 5169287947291197440]",
                                                                                  "[5169745344128352257, 5169780528500441087]",
                                                                                  "[5169780528500441088, 5169780528500441088]",
                                                                                  "[5169780528500441089, 5169815712872529919]",
                                                                                  "[5169850897244618752, 5169850897244618752]",
                                                                                  "[5169886081616707585, 5169921265988796415]",
                                                                                  "[5169921265988796416, 5169921265988796416]",
                                                                                  "[5169932810860888065, 5169933360616701951]",
                                                                                  "[5169933360616701952, 5169933360616701952]",
                                                                                  "[5169934460128329728, 5169934460128329728]",
                                                                                  "[5169938858174840832, 5169938858174840832]",
                                                                                  "[5170132372221329408, 5170132372221329408]"
                                                                          ]
                                                                  }
                                                          }
                                                  },
                                                  {
                                                          "stage" : "FETCH",
                                                          "inputStage" : {
                                                                  "stage" : "IXSCAN",
                                                                  "keyPattern" : {
                                                                          "location.coming_soon" : 1,
                                                                          "location.accessTypeId" : 1,
                                                                          "location.evseList.plugNCharge" : 1,
                                                                          "location.evseList.evsePowerLevel" : 1,
                                                                          "location.evseList.chargeConnectorList.connector" : 1,
                                                                          "coordinates" : "2dsphere"
                                                                  },
                                                                  "indexName" : "location.coming_soon_1_location.accessTypeId_1_location.evseList.plugNCharge_1_location.evseList.evsePowerLevel_1_location.evseList.chargeConnectorList.connector_1_coordinates_2dsphere",
                                                                  "isMultiKey" : true,
                                                                  "multiKeyPaths" : {
                                                                          "location.coming_soon" : [ ],
                                                                          "location.accessTypeId" : [ ],
                                                                          "location.evseList.plugNCharge" : [
                                                                                  "location.evseList"
                                                                          ],
                                                                          "location.evseList.evsePowerLevel" : [
                                                                                  "location.evseList"
                                                                          ],
                                                                          "location.evseList.chargeConnectorList.connector" : [
                                                                                  "location.evseList",
                                                                                  "location.evseList.chargeConnectorList"
                                                                          ],
                                                                          "coordinates" : [ ]
                                                                  },
                                                                  "isUnique" : false,
                                                                  "isSparse" : false,
                                                                  "isPartial" : false,
                                                                  "indexVersion" : 2,
                                                                  "direction" : "forward",
                                                                  "indexBounds" : {
                                                                          "location.coming_soon" : [
                                                                                  "[false, false]"
                                                                          ],
                                                                          "location.accessTypeId" : [
                                                                                  "[-2.0, -2.0]",
                                                                                  "[-1.0, -1.0]",
                                                                                  "[1.0, 1.0]"
                                                                          ],
                                                                          "location.evseList.plugNCharge" : [
                                                                                  "[true, true]"
                                                                          ],
                                                                          "location.evseList.evsePowerLevel" : [
                                                                                  "[MinKey, MaxKey]"
                                                                          ],
                                                                          "location.evseList.chargeConnectorList.connector" : [
                                                                                  "[MinKey, MaxKey]"
                                                                          ],
                                                                          "coordinates" : [
                                                                                  "[5116089176692883456, 5116089176692883456]",
                                                                                  "[5165628772593958912, 5165628772593958912]",
                                                                                  "[5167950941151821824, 5167950941151821824]",
                                                                                  "[5167994921616932865, 5168003717709955071]",
                                                                                  "[5168003717709955072, 5168003717709955072]",
                                                                                  "[5168012513802977281, 5168021309895999487]",
                                                                                  "[5168162047384354816, 5168162047384354816]",
                                                                                  "[5168478706733154305, 5168487502826176511]",
                                                                                  "[5168496298919198720, 5168496298919198720]",
                                                                                  "[5168496298919198721, 5168505095012220927]",
                                                                                  "[5168513891105243136, 5168513891105243136]",
                                                                                  "[5168724997337776128, 5168724997337776128]",
                                                                                  "[5169006472314486784, 5169006472314486784]",
                                                                                  "[5169015268407508993, 5169024064500531199]",
                                                                                  "[5169024064500531200, 5169024064500531200]",
                                                                                  "[5169032860593553409, 5169041656686575615]",
                                                                                  "[5169076841058664448, 5169076841058664448]",
                                                                                  "[5169287947291197440, 5169287947291197440]",
                                                                                  "[5169850897244618752, 5169850897244618752]",
                                                                                  "[5169921265988796416, 5169921265988796416]",
                                                                                  "[5169930062081818625, 5169932261105074175]",
                                                                                  "[5169932261105074177, 5169932810860888063]",
                                                                                  "[5169933360616701952, 5169933360616701952]",
                                                                                  "[5169933360616701953, 5169933910372515839]",
                                                                                  "[5169933910372515841, 5169934460128329727]",
                                                                                  "[5169934460128329728, 5169934460128329728]",
                                                                                  "[5169934460128329729, 5169936659151585279]",
                                                                                  "[5169938858174840832, 5169938858174840832]",
                                                                                  "[5170132372221329408, 5170132372221329408]"
                                                                          ]
                                                                  }
                                                          }
                                                  }
                                          ]
                                  }
                          }
                  },
                  "rejectedPlans" : [ ]
          },
          "executionStats" : {
                  "executionSuccess" : true,
                  "nReturned" : 431,
                  "executionTimeMillis" : 968,
                  "totalKeysExamined" : 12415,
                  "totalDocsExamined" : 8247,
                  "executionStages" : {
                          "isCached" : false,
                          "stage" : "PROJECTION_SIMPLE",
                          "nReturned" : 431,
                          "executionTimeMillisEstimate" : 945,
                          "works" : 15803,
                          "advanced" : 431,
                          "needTime" : 15371,
                          "needYield" : 0,
                          "saveState" : 49,
                          "restoreState" : 49,
                          "isEOF" : 1,
                          "transformBy" : {
                                  "position" : 1
                          },
                          "inputStage" : {
                                  "stage" : "FETCH",
                                  "filter" : {
                                          "$and" : [
                                                  {
                                                          "location.evseList.chargeConnectorList.connector" : {
                                                                  "$in" : [
                                                                          2,
                                                                          6,
                                                                          7,
                                                                          8,
                                                                          13,
                                                                          21
                                                                  ]
                                                          }
                                                  },
                                                  {
                                                          "location.evseList.evsePowerLevel" : {
                                                                  "$eq" : "Ultra Fast"
                                                          }
                                                  }
                                          ]
                                  },
                                  "nReturned" : 431,
                                  "executionTimeMillisEstimate" : 941,
                                  "works" : 15803,
                                  "advanced" : 431,
                                  "needTime" : 15371,
                                  "needYield" : 0,
                                  "saveState" : 49,
                                  "restoreState" : 49,
                                  "isEOF" : 1,
                                  "docsExamined" : 990,
                                  "alreadyHasObj" : 990,
                                  "inputStage" : {
                                          "stage" : "GEO_NEAR_2DSPHERE",
                                          "nReturned" : 990,
                                          "executionTimeMillisEstimate" : 844,
                                          "works" : 15803,
                                          "advanced" : 990,
                                          "needTime" : 14812,
                                          "needYield" : 0,
                                          "saveState" : 49,
                                          "restoreState" : 49,
                                          "isEOF" : 1,
                                          "keyPattern" : {
                                                  "location.coming_soon" : 1,
                                                  "location.accessTypeId" : 1,
                                                  "location.evseList.plugNCharge" : 1,
                                                  "location.evseList.evsePowerLevel" : 1,
                                                  "location.evseList.chargeConnectorList.connector" : 1,
                                                  "coordinates" : "2dsphere"
                                          },
                                          "indexName" : "location.coming_soon_1_location.accessTypeId_1_location.evseList.plugNCharge_1_location.evseList.evsePowerLevel_1_location.evseList.chargeConnectorList.connector_1_coordinates_2dsphere",
                                          "indexVersion" : 2,
                                          "searchIntervals" : [
                                                  {
                                                          "minDistance" : 24000,
                                                          "maxDistance" : 37633.317181384606,
                                                          "maxInclusive" : false,
                                                          "nBuffered" : 313,
                                                          "nReturned" : 166
                                                  },
                                                  {
                                                          "minDistance" : 37633.317181384606,
                                                          "maxDistance" : 64899.95154415381,
                                                          "maxInclusive" : false,
                                                          "nBuffered" : 835,
                                                          "nReturned" : 627
                                                  },
                                                  {
                                                          "minDistance" : 64899.95154415381,
                                                          "maxDistance" : 72000,
                                                          "maxInclusive" : true,
                                                          "nBuffered" : 117,
                                                          "nReturned" : 197
                                                  }
                                          ],
                                          "usedDisk" : true,
                                          "spills" : 3,
                                          "spilledRecords" : 0,
                                          "spilledBytes" : 0,
                                          "spilledDataStorageSize" : 0,
                                          "inputStages" : [
                                                  {
                                                          "stage" : "FETCH",
                                                          "nReturned" : 1971,
                                                          "executionTimeMillisEstimate" : 129,
                                                          "works" : 3059,
                                                          "advanced" : 1971,
                                                          "needTime" : 1087,
                                                          "needYield" : 0,
                                                          "saveState" : 43,
                                                          "restoreState" : 43,
                                                          "isEOF" : 1,
                                                          "docsExamined" : 1971,
                                                          "alreadyHasObj" : 0,
                                                          "inputStage" : {
                                                                  "stage" : "IXSCAN",
                                                                  "nReturned" : 1971,
                                                                  "executionTimeMillisEstimate" : 100,
                                                                  "works" : 3059,
                                                                  "advanced" : 1971,
                                                                  "needTime" : 1087,
                                                                  "needYield" : 0,
                                                                  "saveState" : 43,
                                                                  "restoreState" : 43,
                                                                  "isEOF" : 1,
                                                                  "keyPattern" : {
                                                                          "location.coming_soon" : 1,
                                                                          "location.accessTypeId" : 1,
                                                                          "location.evseList.plugNCharge" : 1,
                                                                          "location.evseList.evsePowerLevel" : 1,
                                                                          "location.evseList.chargeConnectorList.connector" : 1,
                                                                          "coordinates" : "2dsphere"
                                                                  },
                                                                  "indexName" : "location.coming_soon_1_location.accessTypeId_1_location.evseList.plugNCharge_1_location.evseList.evsePowerLevel_1_location.evseList.chargeConnectorList.connector_1_coordinates_2dsphere",
                                                                  "isMultiKey" : true,
                                                                  "multiKeyPaths" : {
                                                                          "location.coming_soon" : [ ],
                                                                          "location.accessTypeId" : [ ],
                                                                          "location.evseList.plugNCharge" : [
                                                                                  "location.evseList"
                                                                          ],
                                                                          "location.evseList.evsePowerLevel" : [
                                                                                  "location.evseList"
                                                                          ],
                                                                          "location.evseList.chargeConnectorList.connector" : [
                                                                                  "location.evseList",
                                                                                  "location.evseList.chargeConnectorList"
                                                                          ],
                                                                          "coordinates" : [ ]
                                                                  },
                                                                  "isUnique" : false,
                                                                  "isSparse" : false,
                                                                  "isPartial" : false,
                                                                  "indexVersion" : 2,
                                                                  "direction" : "forward",
                                                                  "indexBounds" : {
                                                                          "location.coming_soon" : [
                                                                                  "[false, false]"
                                                                          ],
                                                                          "location.accessTypeId" : [
                                                                                  "[-2.0, -2.0]",
                                                                                  "[-1.0, -1.0]",
                                                                                  "[1.0, 1.0]"
                                                                          ],
                                                                          "location.evseList.plugNCharge" : [
                                                                                  "[true, true]"
                                                                          ],
                                                                          "location.evseList.evsePowerLevel" : [
                                                                                  "[MinKey, MaxKey]"
                                                                          ],
                                                                          "location.evseList.chargeConnectorList.connector" : [
                                                                                  "[MinKey, MaxKey]"
                                                                          ],
                                                                          "coordinates" : [
                                                                                  "[5116089176692883456, 5116089176692883456]",
                                                                                  "[5165628772593958912, 5165628772593958912]",
                                                                                  "[5168091678640177152, 5168091678640177152]",
                                                                                  "[5168091678640177153, 5168100474733199359]",
                                                                                  "[5168109270826221568, 5168109270826221568]",
                                                                                  "[5168109270826221569, 5168118066919243775]",
                                                                                  "[5168118066919243777, 5168126863012265983]",
                                                                                  "[5168126863012265985, 5168162047384354815]",
                                                                                  "[5168162047384354816, 5168162047384354816]",
                                                                                  "[5168162047384354817, 5168170843477377023]",
                                                                                  "[5168170843477377025, 5168179639570399231]",
                                                                                  "[5168179639570399232, 5168179639570399232]",
                                                                                  "[5168201629802954752, 5168201629802954752]",
                                                                                  "[5168203828826210305, 5168206027849465855]",
                                                                                  "[5168206027849465857, 5168214823942488063]",
                                                                                  "[5168214823942488064, 5168214823942488064]",
                                                                                  "[5168214823942488065, 5168223620035510271]",
                                                                                  "[5168232416128532480, 5168232416128532480]",
                                                                                  "[5168232416128532481, 5168241212221554687]",
                                                                                  "[5168241212221554689, 5168250008314576895]",
                                                                                  "[5168250008314576896, 5168250008314576896]",
                                                                                  "[5168250008314576897, 5168252207337832447]",
                                                                                  "[5168254406361088000, 5168254406361088000]",
                                                                                  "[5168258804407599105, 5168267600500621311]",
                                                                                  "[5168267600500621313, 5168276396593643519]",
                                                                                  "[5168276396593643521, 5168285192686665727]",
                                                                                  "[5168285192686665728, 5168285192686665728]",
                                                                                  "[5168285192686665729, 5168293988779687935]",
                                                                                  "[5168296187802943489, 5168298386826199039]",
                                                                                  "[5168298386826199040, 5168298386826199040]",
                                                                                  "[5168338519000612865, 5168339068756426751]",
                                                                                  "[5168339068756426752, 5168339068756426752]",
                                                                                  "[5168342367291310080, 5168342367291310080]",
                                                                                  "[5168344566314565633, 5168346765337821183]",
                                                                                  "[5168346765337821185, 5168355561430843391]",
                                                                                  "[5168355561430843392, 5168355561430843392]",
                                                                                  "[5168373153616887808, 5168373153616887808]",
                                                                                  "[5169006472314486784, 5169006472314486784]",
                                                                                  "[5170132372221329408, 5170132372221329408]"
                                                                          ]
                                                                  },
                                                                  "keysExamined" : 3059,
                                                                  "seeks" : 1088,
                                                                  "dupsTested" : 0,
                                                                  "dupsDropped" : 0,
                                                                  "peakTrackedMemBytes" : 0
                                                          }
                                                  },
                                                  {
                                                          "stage" : "FETCH",
                                                          "nReturned" : 4596,
                                                          "executionTimeMillisEstimate" : 320,
                                                          "works" : 6879,
                                                          "advanced" : 4596,
                                                          "needTime" : 2282,
                                                          "needYield" : 0,
                                                          "saveState" : 30,
                                                          "restoreState" : 30,
                                                          "isEOF" : 1,
                                                          "docsExamined" : 4596,
                                                          "alreadyHasObj" : 0,
                                                          "inputStage" : {
                                                                  "stage" : "IXSCAN",
                                                                  "nReturned" : 4596,
                                                                  "executionTimeMillisEstimate" : 219,
                                                                  "works" : 6879,
                                                                  "advanced" : 4596,
                                                                  "needTime" : 2282,
                                                                  "needYield" : 0,
                                                                  "saveState" : 30,
                                                                  "restoreState" : 30,
                                                                  "isEOF" : 1,
                                                                  "keyPattern" : {
                                                                          "location.coming_soon" : 1,
                                                                          "location.accessTypeId" : 1,
                                                                          "location.evseList.plugNCharge" : 1,
                                                                          "location.evseList.evsePowerLevel" : 1,
                                                                          "location.evseList.chargeConnectorList.connector" : 1,
                                                                          "coordinates" : "2dsphere"
                                                                  },
                                                                  "indexName" : "location.coming_soon_1_location.accessTypeId_1_location.evseList.plugNCharge_1_location.evseList.evsePowerLevel_1_location.evseList.chargeConnectorList.connector_1_coordinates_2dsphere",
                                                                  "isMultiKey" : true,
                                                                  "multiKeyPaths" : {
                                                                          "location.coming_soon" : [ ],
                                                                          "location.accessTypeId" : [ ],
                                                                          "location.evseList.plugNCharge" : [
                                                                                  "location.evseList"
                                                                          ],
                                                                          "location.evseList.evsePowerLevel" : [
                                                                                  "location.evseList"
                                                                          ],
                                                                          "location.evseList.chargeConnectorList.connector" : [
                                                                                  "location.evseList",
                                                                                  "location.evseList.chargeConnectorList"
                                                                          ],
                                                                          "coordinates" : [ ]
                                                                  },
                                                                  "isUnique" : false,
                                                                  "isSparse" : false,
                                                                  "isPartial" : false,
                                                                  "indexVersion" : 2,
                                                                  "direction" : "forward",
                                                                  "indexBounds" : {
                                                                          "location.coming_soon" : [
                                                                                  "[false, false]"
                                                                          ],
                                                                          "location.accessTypeId" : [
                                                                                  "[-2.0, -2.0]",
                                                                                  "[-1.0, -1.0]",
                                                                                  "[1.0, 1.0]"
                                                                          ],
                                                                          "location.evseList.plugNCharge" : [
                                                                                  "[true, true]"
                                                                          ],
                                                                          "location.evseList.evsePowerLevel" : [
                                                                                  "[MinKey, MaxKey]"
                                                                          ],
                                                                          "location.evseList.chargeConnectorList.connector" : [
                                                                                  "[MinKey, MaxKey]"
                                                                          ],
                                                                          "coordinates" : [
                                                                                  "[5116089176692883456, 5116089176692883456]",
                                                                                  "[5165628772593958912, 5165628772593958912]",
                                                                                  "[5167950941151821824, 5167950941151821824]",
                                                                                  "[5167950941151821825, 5167986125523910655]",
                                                                                  "[5167986125523910657, 5167994921616932863]",
                                                                                  "[5168003717709955072, 5168003717709955072]",
                                                                                  "[5168021309895999489, 5168056494268088319]",
                                                                                  "[5168056494268088321, 5168091678640177151]",
                                                                                  "[5168091678640177152, 5168091678640177152]",
                                                                                  "[5168100474733199361, 5168109270826221567]",
                                                                                  "[5168109270826221568, 5168109270826221568]",
                                                                                  "[5168162047384354816, 5168162047384354816]",
                                                                                  "[5168232416128532480, 5168232416128532480]",
                                                                                  "[5168250008314576896, 5168250008314576896]",
                                                                                  "[5168252207337832449, 5168254406361087999]",
                                                                                  "[5168254406361088000, 5168254406361088000]",
                                                                                  "[5168254406361088001, 5168256605384343551]",
                                                                                  "[5168256605384343553, 5168258804407599103]",
                                                                                  "[5168285192686665728, 5168285192686665728]",
                                                                                  "[5168293988779687937, 5168296187802943487]",
                                                                                  "[5168298386826199040, 5168298386826199040]",
                                                                                  "[5168298386826199041, 5168300585849454591]",
                                                                                  "[5168300585849454593, 5168302784872710143]",
                                                                                  "[5168302784872710145, 5168337969244798975]",
                                                                                  "[5168337969244798977, 5168338519000612863]",
                                                                                  "[5168339068756426752, 5168339068756426752]",
                                                                                  "[5168339068756426753, 5168339618512240639]",
                                                                                  "[5168339618512240641, 5168340168268054527]",
                                                                                  "[5168340168268054529, 5168342367291310079]",
                                                                                  "[5168342367291310080, 5168342367291310080]",
                                                                                  "[5168342367291310081, 5168344566314565631]",
                                                                                  "[5168355561430843392, 5168355561430843392]",
                                                                                  "[5168355561430843393, 5168364357523865599]",
                                                                                  "[5168364357523865601, 5168373153616887807]",
                                                                                  "[5168373153616887808, 5168373153616887808]",
                                                                                  "[5168487502826176513, 5168496298919198719]",
                                                                                  "[5168496298919198720, 5168496298919198720]",
                                                                                  "[5168513891105243136, 5168513891105243136]",
                                                                                  "[5168724997337776128, 5168724997337776128]",
                                                                                  "[5168936103570309120, 5168936103570309120]",
                                                                                  "[5168936103570309121, 5168971287942397951]",
                                                                                  "[5168971287942397953, 5169006472314486783]",
                                                                                  "[5169006472314486784, 5169006472314486784]",
                                                                                  "[5169006472314486785, 5169015268407508991]",
                                                                                  "[5169024064500531200, 5169024064500531200]",
                                                                                  "[5169076841058664448, 5169076841058664448]",
                                                                                  "[5169287947291197440, 5169287947291197440]",
                                                                                  "[5169745344128352257, 5169780528500441087]",
                                                                                  "[5169780528500441088, 5169780528500441088]",
                                                                                  "[5169780528500441089, 5169815712872529919]",
                                                                                  "[5169850897244618752, 5169850897244618752]",
                                                                                  "[5169886081616707585, 5169921265988796415]",
                                                                                  "[5169921265988796416, 5169921265988796416]",
                                                                                  "[5169932810860888065, 5169933360616701951]",
                                                                                  "[5169933360616701952, 5169933360616701952]",
                                                                                  "[5169934460128329728, 5169934460128329728]",
                                                                                  "[5169938858174840832, 5169938858174840832]",
                                                                                  "[5170132372221329408, 5170132372221329408]"
                                                                          ]
                                                                  },
                                                                  "keysExamined" : 6879,
                                                                  "seeks" : 2283,
                                                                  "dupsTested" : 0,
                                                                  "dupsDropped" : 0,
                                                                  "peakTrackedMemBytes" : 0
                                                          }
                                                  },
                                                  {
                                                          "stage" : "FETCH",
                                                          "nReturned" : 690,
                                                          "executionTimeMillisEstimate" : 139,
                                                          "works" : 2477,
                                                          "advanced" : 690,
                                                          "needTime" : 1786,
                                                          "needYield" : 0,
                                                          "saveState" : 8,
                                                          "restoreState" : 8,
                                                          "isEOF" : 1,
                                                          "docsExamined" : 690,
                                                          "alreadyHasObj" : 0,
                                                          "inputStage" : {
                                                                  "stage" : "IXSCAN",
                                                                  "nReturned" : 690,
                                                                  "executionTimeMillisEstimate" : 119,
                                                                  "works" : 2477,
                                                                  "advanced" : 690,
                                                                  "needTime" : 1786,
                                                                  "needYield" : 0,
                                                                  "saveState" : 8,
                                                                  "restoreState" : 8,
                                                                  "isEOF" : 1,
                                                                  "keyPattern" : {
                                                                          "location.coming_soon" : 1,
                                                                          "location.accessTypeId" : 1,
                                                                          "location.evseList.plugNCharge" : 1,
                                                                          "location.evseList.evsePowerLevel" : 1,
                                                                          "location.evseList.chargeConnectorList.connector" : 1,
                                                                          "coordinates" : "2dsphere"
                                                                  },
                                                                  "indexName" : "location.coming_soon_1_location.accessTypeId_1_location.evseList.plugNCharge_1_location.evseList.evsePowerLevel_1_location.evseList.chargeConnectorList.connector_1_coordinates_2dsphere",
                                                                  "isMultiKey" : true,
                                                                  "multiKeyPaths" : {
                                                                          "location.coming_soon" : [ ],
                                                                          "location.accessTypeId" : [ ],
                                                                          "location.evseList.plugNCharge" : [
                                                                                  "location.evseList"
                                                                          ],
                                                                          "location.evseList.evsePowerLevel" : [
                                                                                  "location.evseList"
                                                                          ],
                                                                          "location.evseList.chargeConnectorList.connector" : [
                                                                                  "location.evseList",
                                                                                  "location.evseList.chargeConnectorList"
                                                                          ],
                                                                          "coordinates" : [ ]
                                                                  },
                                                                  "isUnique" : false,
                                                                  "isSparse" : false,
                                                                  "isPartial" : false,
                                                                  "indexVersion" : 2,
                                                                  "direction" : "forward",
                                                                  "indexBounds" : {
                                                                          "location.coming_soon" : [
                                                                                  "[false, false]"
                                                                          ],
                                                                          "location.accessTypeId" : [
                                                                                  "[-2.0, -2.0]",
                                                                                  "[-1.0, -1.0]",
                                                                                  "[1.0, 1.0]"
                                                                          ],
                                                                          "location.evseList.plugNCharge" : [
                                                                                  "[true, true]"
                                                                          ],
                                                                          "location.evseList.evsePowerLevel" : [
                                                                                  "[MinKey, MaxKey]"
                                                                          ],
                                                                          "location.evseList.chargeConnectorList.connector" : [
                                                                                  "[MinKey, MaxKey]"
                                                                          ],
                                                                          "coordinates" : [
                                                                                  "[5116089176692883456, 5116089176692883456]",
                                                                                  "[5165628772593958912, 5165628772593958912]",
                                                                                  "[5167950941151821824, 5167950941151821824]",
                                                                                  "[5167994921616932865, 5168003717709955071]",
                                                                                  "[5168003717709955072, 5168003717709955072]",
                                                                                  "[5168012513802977281, 5168021309895999487]",
                                                                                  "[5168162047384354816, 5168162047384354816]",
                                                                                  "[5168478706733154305, 5168487502826176511]",
                                                                                  "[5168496298919198720, 5168496298919198720]",
                                                                                  "[5168496298919198721, 5168505095012220927]",
                                                                                  "[5168513891105243136, 5168513891105243136]",
                                                                                  "[5168724997337776128, 5168724997337776128]",
                                                                                  "[5169006472314486784, 5169006472314486784]",
                                                                                  "[5169015268407508993, 5169024064500531199]",
                                                                                  "[5169024064500531200, 5169024064500531200]",
                                                                                  "[5169032860593553409, 5169041656686575615]",
                                                                                  "[5169076841058664448, 5169076841058664448]",
                                                                                  "[5169287947291197440, 5169287947291197440]",
                                                                                  "[5169850897244618752, 5169850897244618752]",
                                                                                  "[5169921265988796416, 5169921265988796416]",
                                                                                  "[5169930062081818625, 5169932261105074175]",
                                                                                  "[5169932261105074177, 5169932810860888063]",
                                                                                  "[5169933360616701952, 5169933360616701952]",
                                                                                  "[5169933360616701953, 5169933910372515839]",
                                                                                  "[5169933910372515841, 5169934460128329727]",
                                                                                  "[5169934460128329728, 5169934460128329728]",
                                                                                  "[5169934460128329729, 5169936659151585279]",
                                                                                  "[5169938858174840832, 5169938858174840832]",
                                                                                  "[5170132372221329408, 5170132372221329408]"
                                                                          ]
                                                                  },
                                                                  "keysExamined" : 2477,
                                                                  "seeks" : 1787,
                                                                  "dupsTested" : 0,
                                                                  "dupsDropped" : 0,
                                                                  "peakTrackedMemBytes" : 0
                                                          }
                                                  }
                                          ]
                                  }
                          }
                  }
          },
          "queryShapeHash" : "934D28D1C98FD2E83CD6518CAC41982983BEB979AB93EF9EC582700BDF266133",
          "command" : {
                  "find" : "batchMergeData",
                  "filter" : {
                          "$and" : [
                                  {
                                          "coordinates" : {
                                                  "$near" : {
                                                          "$geometry" : {
                                                                  "type" : "Point",
                                                                  "coordinates" : [
                                                                          7.481319978833198,
                                                                          51.45842169665437
                                                                  ]
                                                          },
                                                          "$maxDistance" : 72000,
                                                          "$minDistance" : 24000
                                                  }
                                          }
                                  },
                                  {
                                          "$and" : [
                                                  {
                                                          "location.coming_soon" : false
                                                  },
                                                  {
                                                          "location.accessTypeId" : {
                                                                  "$in" : [
                                                                          -2,
                                                                          -1,
                                                                          1
                                                                  ]
                                                          }
                                                  },
                                                  {
                                                          "location.evseList.chargeConnectorList.connector" : {
                                                                  "$in" : [
                                                                          2,
                                                                          13,
                                                                          7,
                                                                          8,
                                                                          6,
                                                                          21
                                                                  ]
                                                          }
                                                  },
                                                  {
                                                          "location.evseList.plugNCharge" : true
                                                  },
                                                  {
                                                          "location.evseList.evsePowerLevel" : {
                                                                  "$in" : [
                                                                          "Ultra Fast"
                                                                  ]
                                                          }
                                                  }
                                          ]
                                  }
                          ]
                  },
                  "projection" : {
                          "position" : 1
                  },
                  "hint" : {
                          "location.coming_soon" : 1,
                          "location.accessTypeId" : 1,
                          "location.evseList.plugNCharge" : 1,
                          "location.evseList.evsePowerLevel" : 1,
                          "location.evseList.chargeConnectorList.connector" : 1,
                          "coordinates" : "2dsphere"
                  },
                  "$db" : "test"
          },
          "serverInfo" : {
                  "host" : "ip-10-128-3-64",
                  "port" : 27017,
                  "version" : "8.3.0-alpha0",
                  "gitVersion" : "nogitversion"
          },
          "serverParameters" : {
                  "internalQueryFacetBufferSizeBytes" : 104857600,
                  "internalDocumentSourceGroupMaxMemoryBytes" : 104857600,
                  "internalQueryMaxBlockingSortMemoryUsageBytes" : 104857600,
                  "internalDocumentSourceSetWindowFieldsMaxMemoryBytes" : 104857600,
                  "internalQueryFacetMaxOutputDocSizeBytes" : 104857600,
                  "internalLookupStageIntermediateDocumentMaxSizeBytes" : 104857600,
                  "internalQueryProhibitBlockingMergeOnMongoS" : 0,
                  "internalQueryMaxAddToSetBytes" : 104857600,
                  "internalQueryFrameworkControl" : "trySbeRestricted",
                  "internalQueryPlannerIgnoreIndexWithCollationForRegex" : 1
          },
          "ok" : 1,
          "$clusterTime" : {
                  "clusterTime" : Timestamp(1763401492, 1),
                  "signature" : {
                          "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),
                          "keyId" : NumberLong(0)
                  }
          },
          "operationTime" : Timestamp(1763401492, 1)
  }
  

      </textarea>
      <button id="show_button" type="submit" class="btn btn-primary">Show<span class="glyphicon glyphicon-map-marker"/></button>
      <button id="prev_button" type="submit" class="btn btn-primary">Prev Stage</button>
      <button id="next_button" type="submit" class="btn btn-primary">Next Stage</button>
    </div>

    <div id="map-canvas"></div>
    <div id="drop-container"><div id="drop-silhouette"></div></div>
  </body>
</html>
